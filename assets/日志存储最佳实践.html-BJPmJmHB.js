import{_ as n,c as l,f as a,o as e}from"./app-chPKMbRn.js";const t={};function o(p,s){return e(),l("div",null,s[0]||(s[0]=[a(`<h2 id="操作指南" tabindex="-1"><a class="header-anchor" href="#操作指南"><span>操作指南</span></a></h2><h3 id="第-1-步-评估资源" tabindex="-1"><a class="header-anchor" href="#第-1-步-评估资源"><span>第 1 步：评估资源</span></a></h3><p>在部署集群之前，首先应评估所需服务器硬件资源，包括以下几个关键步骤：</p><ol><li><strong>评估写入资源</strong>：计算公式如下：</li></ol><ul><li><code>平均写入吞吐 = 日增数据量 / 86400 s</code></li><li><code>峰值写入吞吐 = 平均写入吞吐 * 写入吞吐峰值 / 均值比</code></li><li><code>峰值写入所需 CPU 核数 = 峰值写入吞吐 / 单核写入吞吐</code></li></ul><ol><li><strong>评估存储资源</strong>：计算公式为 <code>所需存储空间 = 日增数据量 / 压缩率 * 副本数 * 数据存储周期</code></li><li><strong>评估查询资源</strong>：查询的资源消耗随查询量和复杂度而异，建议初始预留 50% 的 CPU 资源用于查询，再根据实际测试情况进行调整。</li><li><strong>汇总整合资源</strong>：由第 1 步和第 3 步估算出所需 CPU 核数后，除以单机 CPU 核数，估算出 BE 服务器数量，再根据 BE 服务器数量和第 2 步的结果，估算出每台 BE 服务器所需存储空间，然后分摊到 4～12 块数据盘，计算出单盘存储容量。</li></ol><p>以每天新增 100 TB 数据量（压缩前）、5 倍压缩率、1 副本、热数据存储 3 天、冷数据存储 30 天、写入吞吐峰值 / 均值比 200%、单核写入吞吐 10 MB/s、查询预留 50% CPU 资源为例，可估算出：</p><ul><li>FE：3 台服务器，每台配置 16 核 CPU、64 GB 内存、1 块 100 GB SSD 盘</li><li>BE：15 台服务器，每台配置 32 核 CPU、256 GB 内存、10 块 600 GB SSD 盘</li><li>S3 对象存储空间：即为预估冷数据存储空间，600 TB</li></ul><p>该例子中，各关键指标的值及具体计算方法可见下表：</p><table><thead><tr><th style="text-align:left;">关键指标（单位）</th><th style="text-align:left;">值</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">日增数据量（TB）</td><td style="text-align:left;">100</td><td style="text-align:left;">根据实际需求填写</td></tr><tr><td style="text-align:left;">压缩率</td><td style="text-align:left;">5</td><td style="text-align:left;">一般为 3～10 倍（含索引），根据实际需求填写</td></tr><tr><td style="text-align:left;">副本数</td><td style="text-align:left;">1</td><td style="text-align:left;">根据实际需求填写，默认 1 副本，可选值：1，2，3</td></tr><tr><td style="text-align:left;">热数据存储周期（天）</td><td style="text-align:left;">3</td><td style="text-align:left;">根据实际需求填写</td></tr><tr><td style="text-align:left;">冷数据存储周期（天）</td><td style="text-align:left;">30</td><td style="text-align:left;">根据实际需求填写</td></tr><tr><td style="text-align:left;">总存储周期（天）</td><td style="text-align:left;">33</td><td style="text-align:left;">算法：<code>热数据存储周期 + 冷数据存储周期</code></td></tr><tr><td style="text-align:left;">预估热数据存储空间（TB）</td><td style="text-align:left;">60</td><td style="text-align:left;">算法：<code>日增数据量 / 压缩率 * 副本数 * 热数据存储周期</code></td></tr><tr><td style="text-align:left;">预估冷数据存储空间（TB）</td><td style="text-align:left;">600</td><td style="text-align:left;">算法：<code>日增数据量 / 压缩率 * 副本数 * 冷数据存储周期</code></td></tr><tr><td style="text-align:left;">写入吞吐峰值 / 均值比</td><td style="text-align:left;">200%</td><td style="text-align:left;">根据实际需求填写，默认 200%</td></tr><tr><td style="text-align:left;">单机 CPU 核数</td><td style="text-align:left;">32</td><td style="text-align:left;">根据实际需求填写，默认 32 核</td></tr><tr><td style="text-align:left;">平均写入吞吐（MB/s）</td><td style="text-align:left;">1214</td><td style="text-align:left;">算法：<code>日增数据量 / 86400 s</code></td></tr><tr><td style="text-align:left;">峰值写入吞吐（MB/s）</td><td style="text-align:left;">2427</td><td style="text-align:left;">算法：<code>平均写入吞吐 * 写入吞吐峰值 / 均值比</code></td></tr><tr><td style="text-align:left;">峰值写入所需 CPU 核数</td><td style="text-align:left;">242.7</td><td style="text-align:left;">算法：<code>峰值写入吞吐 / 单核写入吞吐</code></td></tr><tr><td style="text-align:left;">查询预留 CPU 百分比</td><td style="text-align:left;">50%</td><td style="text-align:left;">根据实际需求填写，默认 50%</td></tr><tr><td style="text-align:left;">预估 BE 服务器数</td><td style="text-align:left;">15.2</td><td style="text-align:left;">算法：<code>峰值写入所需 CPU 核数 / 单机 CPU 核数 /（1 - 查询预留 CPU 百分比）</code></td></tr><tr><td style="text-align:left;">预估 BE 服务器数取整</td><td style="text-align:left;">15</td><td style="text-align:left;">算法：<code>MAX (副本数，预估 BE 服务器数取整)</code></td></tr><tr><td style="text-align:left;">预估每台 BE 服务器存储空间（TB）</td><td style="text-align:left;">5.7</td><td style="text-align:left;">算法：<code>预估热数据存储空间 / 预估 BE 服务器数 /（1 - 30%）</code>，其中，30% 是存储空间预留值。建议每台 BE 服务器挂载 4～12 块数据盘，以提高 I/O 能力。</td></tr></tbody></table><h3 id="第-2-步-部署集群" tabindex="-1"><a class="header-anchor" href="#第-2-步-部署集群"><span>第 2 步：部署集群</span></a></h3><p>完成资源评估后，可以开始部署 Apache Doris 集群，推荐在物理机及虚拟机环境中进行部署。</p><h3 id="第-3-步-优化-fe-和-be-配置" tabindex="-1"><a class="header-anchor" href="#第-3-步-优化-fe-和-be-配置"><span>第 3 步：优化 FE 和 BE 配置</span></a></h3><p>完成集群部署后，需分别优化 FE 和 BE 配置参数，以更加契合日志存储与分析的场景。</p><p><strong>优化 FE 配置</strong></p><p>在 <code>fe/conf/fe.conf</code> 目录下找到 FE 的相关配置项，并按照以下表格，调整 FE 配置。</p><table><thead><tr><th style="text-align:left;">需调整参数</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;"><code>max_running_txn_num_per_db = 10000</code></td><td style="text-align:left;">高并发导入运行事务数较多，需调高参数。</td></tr><tr><td style="text-align:left;"><code>streaming_label_keep_max_second = 3600</code> <code>label_keep_max_second = 7200</code></td><td style="text-align:left;">高频导入事务标签内存占用多，保留时间调短。</td></tr><tr><td style="text-align:left;"><code>enable_round_robin_create_tablet = true</code></td><td style="text-align:left;">创建 Tablet 时，采用 Round Robin 策略，尽量均匀。</td></tr><tr><td style="text-align:left;"><code>tablet_rebalancer_type = partition</code></td><td style="text-align:left;">均衡 Tablet 时，采用每个分区内尽量均匀的策略。</td></tr><tr><td style="text-align:left;"><code>autobucket_min_buckets = 10</code></td><td style="text-align:left;">将自动分桶的最小分桶数从 1 调大到 10，避免日志量增加时分桶不够。</td></tr><tr><td style="text-align:left;"><code>max_backend_heartbeat_failure_tolerance_count = 10</code></td><td style="text-align:left;">日志场景下 BE 服务器压力较大，可能短时间心跳超时，因此将容忍次数从 1 调大到 10。</td></tr></tbody></table><p>更多关于 FE 配置项的信息，可参考 <a href="https://doris.apache.org/zh-CN/docs/admin-manual/config/fe-config" target="_blank" rel="noopener noreferrer">FE 配置项</a>。</p><p><strong>优化 BE 配置</strong></p><p>在 <code>be/conf/be.conf</code> 目录下找到 BE 的相关配置项，并按照以下表格，调整 BE 配置。</p><table><thead><tr><th style="text-align:left;">模块</th><th style="text-align:left;">需调整参数</th><th style="text-align:left;">说明</th></tr></thead><tbody><tr><td style="text-align:left;">存储</td><td style="text-align:left;"><code>storage_root_path = /path/to/dir1;/path/to/dir2;...;/path/to/dir12</code></td><td style="text-align:left;">配置热数据在磁盘目录上的存储路径。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>enable_file_cache = true</code></td><td style="text-align:left;">开启文件缓存。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>file_cache_path = [{&quot;path&quot;: &quot;/mnt/datadisk0/file_cache&quot;, &quot;total_size&quot;:53687091200, &quot;query_limit&quot;: &quot;10737418240&quot;},{&quot;path&quot;: &quot;/mnt/datadisk1/file_cache&quot;, &quot;total_size&quot;:53687091200,&quot;query_limit&quot;: &quot;10737418240&quot;}]</code></td><td style="text-align:left;">配置冷数据的缓存路径和相关设置，具体配置说明如下： <code>path</code>：缓存路径 <code>total_size</code>：该缓存路径的总大小，单位为字节，53687091200 字节等于 50 GB <code>query_limit</code>：单次查询可以从缓存路径中查询的最大数据量，单位为字节，10737418240 字节等于 10 GB</td></tr><tr><td style="text-align:left;">写入</td><td style="text-align:left;"><code>write_buffer_size = 1073741824</code></td><td style="text-align:left;">增加写入缓冲区（buffer）的文件大小，减少小文件和随机 I/O 操作，提升性能。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>max_tablet_version_num = 20000</code></td><td style="text-align:left;">配合建表的 time_series compaction 策略，允许更多版本暂时未合并。</td></tr><tr><td style="text-align:left;">Compaction</td><td style="text-align:left;"><code>max_cumu_compaction_threads = 8</code></td><td style="text-align:left;">设置为 CPU 核数 / 4，意味着 CPU 资源的 1/4 用于写入，1/4 用于后台 Compaction，2/1 留给查询和其他操作。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>inverted_index_compaction_enable = true</code></td><td style="text-align:left;">开启索引合并（index compaction），减少 Compaction 时的 CPU 消耗。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>enable_segcompaction = false</code> <code>enable_ordered_data_compaction = false</code></td><td style="text-align:left;">关闭日志场景不需要的两个 Compaction 功能。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>enable_compaction_priority_scheduling = false</code></td><td style="text-align:left;">低优先级 compaction 在一块盘上限制 2 个任务，会影响 compaction 速度。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>total_permits_for_compaction_score = 200000</code></td><td style="text-align:left;">该参数用来控制内存，time series 策略下本身可以控制内存。</td></tr><tr><td style="text-align:left;">缓存</td><td style="text-align:left;"><code>disable_storage_page_cache = true</code> <code>inverted_index_searcher_cache_limit = 30%</code></td><td style="text-align:left;">因为日志数据量较大，缓存（cache）作用有限，因此关闭数据缓存，调换为索引缓存（index cache）的方式。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>inverted_index_cache_stale_sweep_time_sec = 3600</code> <code>index_cache_entry_stay_time_after_lookup_s = 3600</code></td><td style="text-align:left;">让索引缓存在内存中尽量保留 1 小时。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>enable_inverted_index_cache_on_cooldown = true</code> <code>enable_write_index_searcher_cache = false</code></td><td style="text-align:left;">开启索引上传冷数据存储时自动缓存的功能。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>tablet_schema_cache_recycle_interval = 3600</code> <code>segment_cache_capacity = 20000</code></td><td style="text-align:left;">减少其他缓存对内存的占用。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>inverted_index_ram_dir_enable = true</code></td><td style="text-align:left;">减少写入时索引临时文件带来的 IO 开销。</td></tr><tr><td style="text-align:left;">线程</td><td style="text-align:left;"><code>pipeline_executor_size = 24</code> <code>doris_scanner_thread_pool_thread_num = 48</code></td><td style="text-align:left;">32 核 CPU 的计算线程和 I/O 线程配置，根据核数等比扩缩。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>scan_thread_nice_value = 5</code></td><td style="text-align:left;">降低查询 I/O 线程的优先级，保证写入性能和时效性。</td></tr><tr><td style="text-align:left;">其他</td><td style="text-align:left;"><code>string_type_length_soft_limit_bytes = 10485760</code></td><td style="text-align:left;">将 String 类型数据的长度限制调高至 10 MB。</td></tr><tr><td style="text-align:left;">-</td><td style="text-align:left;"><code>trash_file_expire_time_sec = 300</code> <code>path_gc_check_interval_second = 900</code> <code>path_scan_interval_second = 900</code></td><td style="text-align:left;">调快垃圾文件的回收时间。</td></tr></tbody></table><p>更多关于 BE 配置项的信息，可参考 <a href="https://doris.apache.org/zh-CN/docs/admin-manual/config/be-config" target="_blank" rel="noopener noreferrer">BE 配置项</a>。</p><h3 id="第-4-步-建表" tabindex="-1"><a class="header-anchor" href="#第-4-步-建表"><span>第 4 步：建表</span></a></h3><p>由于日志数据的写入和查询都具备明显的特征，因此，在建表时按照本节说明进行针对性配置，以提升性能表现。</p><p><strong>配置分区分桶参数</strong></p><p>分区时，按照以下说明配置：</p><ul><li>使用时间字段上的 (range 分区) (<code>PARTITION BY RANGE(</code>ts<code>)</code>)，并开启 <a href="https://doris.apache.org/zh-CN/docs/table-design/data-partitioning/dynamic-partitioning" target="_blank" rel="noopener noreferrer">动态分区</a> (<code>&quot;dynamic_partition.enable&quot; = &quot;true&quot;</code>)，按天自动管理分区。</li><li>使用 Datetime 类型的时间字段作为 Key (<code>DUPLICATE KEY(ts)</code>)，在查询最新 N 条日志时有数倍加速。</li></ul><p>分桶时，按照以下说明配置：</p><ul><li>分桶数量大致为集群磁盘总数的 3 倍，每个桶的数据量压缩后 5GB 左右。</li><li>使用 Random 策略 (<code>DISTRIBUTED BY RANDOM BUCKETS 60</code>)，配合写入时的 Single Tablet 导入，可以提升批量（Batch）写入的效率。</li></ul><p>更多关于分区分桶的信息，可参考 <a href="https://doris.apache.org/zh-CN/docs/table-design/data-partitioning/basic-concepts" target="_blank" rel="noopener noreferrer">数据划分</a>。</p><p><strong>配置压缩参数</strong></p><ul><li>使用 zstd 压缩算法 (<code>&quot;compression&quot; = &quot;zstd&quot;</code>), 提高数据压缩率。</li></ul><p><strong>配置 Compaction 参数</strong></p><p>按照以下说明配置 Compaction 参数：</p><ul><li>使用 time_series 策略 (<code>&quot;compaction_policy&quot; = &quot;time_series&quot;</code>)，以减轻写放大效应，对于高吞吐日志写入的资源写入很重要。</li></ul><p><strong>建立和配置索引参数</strong></p><p>按照以下说明操作：</p><ul><li>对经常查询的字段建立索引 (<code>USING INVERTED</code>)。</li><li>对需要全文检索的字段，将分词器（parser）参数赋值为 unicode，一般能满足大部分需求。如有支持短语查询的需求，将 support_phrase 参数赋值为 true；如不需要，则设置为 false，以降低存储空间。</li></ul><p><strong>配置存储策略</strong></p><p>按照以下说明操作：</p><ul><li>对于热存储数据，如果使用云盘，可配置 1 副本；如果使用物理盘，则至少配置 2 副本 (<code>&quot;replication_num&quot; = &quot;2&quot;</code>)。</li><li>配置 <code>log_s3</code> 的存储位置 (<code>CREATE RESOURCE &quot;log_s3&quot;</code>)，并设置 <code>log_policy_3day</code> 冷热数据分层策略 (<code>CREATE STORAGE POLICY log_policy_3day</code>)，即在超过 3 天后将数据冷却至 <code>log_s3</code> 指定的存储位置。可参考以下代码：</li></ul><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> DATABASE</span><span style="color:#88C0D0;"> log_db</span><span style="color:#D8DEE9FF;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">USE</span><span style="color:#D8DEE9FF;"> log_db;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> RESOURCE</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">log_s3</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">PROPERTIES</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">(</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">type</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">s3</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">s3.endpoint</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_endpoint_url</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">s3.region</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_region</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">s3.bucket</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_bucket</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">s3.root.path</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_path</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">s3.access_key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_ak</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">s3.secret_key</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_sk</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">);</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#D8DEE9FF;"> STORAGE </span><span style="color:#81A1C1;">POLICY</span><span style="color:#D8DEE9FF;"> log_policy_3day</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">PROPERTIES(</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">storage_resource</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">log_s3</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;">cooldown_ttl</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">259200</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">);</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#81A1C1;"> TABLE</span><span style="color:#88C0D0;"> log_table</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">(</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  \`</span><span style="color:#A3BE8C;">ts</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> DATETIME</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  \`</span><span style="color:#A3BE8C;">host</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> TEXT</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  \`</span><span style="color:#A3BE8C;">path</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> TEXT</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  \`</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">\`</span><span style="color:#81A1C1;"> TEXT</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  INDEX</span><span style="color:#D8DEE9FF;"> idx_host (</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">host</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">USING</span><span style="color:#D8DEE9FF;"> INVERTED,</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  INDEX</span><span style="color:#D8DEE9FF;"> idx_path (</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">path</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">USING</span><span style="color:#D8DEE9FF;"> INVERTED,</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  INDEX</span><span style="color:#D8DEE9FF;"> idx_message (</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">message</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">USING</span><span style="color:#D8DEE9FF;"> INVERTED PROPERTIES(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">parser</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">unicode</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">support_phrase</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">true</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">ENGINE </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> OLAP</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">DUPLICATE </span><span style="color:#81A1C1;">KEY</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">ts</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">PARTITION</span><span style="color:#81A1C1;"> BY</span><span style="color:#81A1C1;"> RANGE</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">\`</span><span style="color:#A3BE8C;">ts</span><span style="color:#ECEFF4;">\`</span><span style="color:#D8DEE9FF;">) </span><span style="color:#ECEFF4;">()</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">DISTRIBUTED</span><span style="color:#81A1C1;"> BY</span><span style="color:#D8DEE9FF;"> RANDOM BUCKETS </span><span style="color:#B48EAD;">60</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">PROPERTIES (</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">compression</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">zstd</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">compaction_policy</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">time_series</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.enable</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">true</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.create_history_partition</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">true</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.time_unit</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">DAY</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.start</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">-30</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.prefix</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">p</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.buckets</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">60</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">dynamic_partition.replication_num</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">2</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#616E88;">-- 存算分离不需要</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">replication_num</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">2</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#616E88;">-- 存算分离不需要</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">  &quot;</span><span style="color:#A3BE8C;">storage_policy</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">log_policy_3day</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#616E88;"> -- 存算分离不需要</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">);</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="第-5-步-采集日志" tabindex="-1"><a class="header-anchor" href="#第-5-步-采集日志"><span>第 5 步：采集日志</span></a></h3><p>完成建表后，可进行日志采集。</p><p>Apache Doris 提供开放、通用的 Stream HTTP APIs，通过这些 APIs，你可与常用的日志采集器打通，包括 Logstash、Filebeat、Kafka 等，从而开展日志采集工作。本节介绍了如何使用 Stream HTTP APIs 对接日志采集器。</p><p><strong>对接 Filebeat</strong></p><p>按照以下步骤操作：</p><ol><li>获取支持输出至 Apache Doris 的 Filebeat 二进制文件。可 <a href="https://apache-doris-releases.oss-accelerate.aliyuncs.com/filebeat-doris-1.0.0" target="_blank" rel="noopener noreferrer">点此下载</a> 或者从 Apache Doris 源码编译。</li><li>配置 Filebeat。需配置以下参数：</li></ol><ul><li><p><code>filebeat_demo.yml</code>：配置所采集日志的具体输入路径和输出到 Apache Doris 的设置。</p><div class="language-yaml line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="yml" data-title="yml"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-yaml;"><code><span class="line"><span class="line"><span style="color:#616E88;"># input</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">filebeat.inputs</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">-</span><span style="color:#8FBCBB;"> type</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> log</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  enabled</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  paths</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    -</span><span style="color:#A3BE8C;"> /path/to/your/log</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">  # multiline 可以将跨行的日志（比如 Java stacktrace）拼接起来</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  multiline</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    type</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> pattern</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    # 效果：以 yyyy-mm-dd HH:MM:SS 开头的行认为是一条新的日志，其他都拼接到上一条日志</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    pattern</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}</span><span style="color:#ECEFF4;">&#39;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    negate</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    match</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> after</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    skip_newline</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">processors</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"># 用 js script 插件将日志中的 \\t 替换成空格，避免 JSON 解析报错</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">-</span><span style="color:#8FBCBB;"> script</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    lang</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> javascript</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    source</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> &gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#A3BE8C;">        function process(event) {</span></span></span>
<span class="line"><span class="line"><span style="color:#A3BE8C;">            var msg = event.Get(&quot;message&quot;);</span></span></span>
<span class="line"><span class="line"><span style="color:#A3BE8C;">            msg = msg.replace(/\\t/g, &quot;  &quot;);</span></span></span>
<span class="line"><span class="line"><span style="color:#A3BE8C;">            event.Put(&quot;message&quot;, msg);</span></span></span>
<span class="line"><span class="line"><span style="color:#A3BE8C;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"># 用 dissect 插件做简单的日志解析</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">-</span><span style="color:#8FBCBB;"> dissect</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    # 2024-06-08 18:26:25,481 INFO (report-thread|199) [ReportHandler.cpuReport():617] begin to handle</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    tokenizer</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">%{day} %{time} %{log_level} (%{thread}) [%{position}] %{content}</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    target_prefix</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    ignore_failure</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    overwrite_keys</span><span style="color:#ECEFF4;">:</span><span style="color:#81A1C1;"> true</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"># queue and batch</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">queue.mem</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  events</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 1000000</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  flush.min_events</span><span style="color:#ECEFF4;">:</span><span style="color:#B48EAD;"> 100000</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  flush.timeout</span><span style="color:#ECEFF4;">:</span><span style="color:#A3BE8C;"> 10s</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"># output</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">output.doris</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  fenodes</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> [</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">http://fehost1:http_port</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">http://fehost2:http_port</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">http://fehost3:http_port</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;"> ]</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  user</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_username</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  password</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_password</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  database</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_db</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  table</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_table</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">  # output string format</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">  ## %{[agent][hostname]} %{[log][file][path]} 是filebeat自带的metadata</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">  ## 常用的 filebeat metadata 还是有采集时间戳 %{[@timestamp]}</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">  ## %{[day]} %{[time]} 是上面 dissect 解析得到字段</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  codec_format_string</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">{&quot;ts&quot;: &quot;%{[day]} %{[time]}&quot;, &quot;host&quot;: &quot;%{[agent][hostname]}&quot;, &quot;path&quot;: &quot;%{[log][file][path]}&quot;, &quot;message&quot;: &quot;%{[message]}&quot;}</span><span style="color:#ECEFF4;">&#39;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">  headers</span><span style="color:#ECEFF4;">:</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    format</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">json</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    read_json_by_line</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">true</span><span style="color:#ECEFF4;">&quot;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    load_to_single_tablet</span><span style="color:#ECEFF4;">:</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">true</span><span style="color:#ECEFF4;">&quot;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ul><ol><li>按照下方命令运行 Filebeat，采集日志并输出至 Apache Doris。</li></ol><div class="language-bash line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-bash;"><code><span class="line"><span class="line"><span style="color:#88C0D0;">chmod</span><span style="color:#A3BE8C;"> +x</span><span style="color:#A3BE8C;"> filebeat-doris-1.0.0</span><span style="color:#D8DEE9FF;">  </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">./filebeat-doris-1.0.0</span><span style="color:#A3BE8C;"> -c</span><span style="color:#A3BE8C;"> filebeat_demo.yml</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>更多关于 Filebeat 配置和使用的说明，可参考 <a href="https://doris.apache.org/zh-CN/docs/ecosystem/beats" target="_blank" rel="noopener noreferrer">Beats Doris Output Plugin</a>。</p><p><strong>对接 Kafka</strong></p><p>将 JSON 格式的日志写入 Kafka 的消息队列，创建 Kafka Routine Load，即可让 Apache Doris 从 Kafka 主动拉取数据。</p><p>可参考如下示例。其中，<code>property.*</code> 是 Librdkafka 客户端相关配置，根据实际 Kafka 集群情况配置。</p><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#616E88;">-- 准备好 kafka 集群和 topic log__topic_  </span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">-- 创建 routine load，从 kafka log__topic_将数据导入 log_table 表  </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">CREATE</span><span style="color:#D8DEE9FF;"> ROUTINE </span><span style="color:#81A1C1;">LOAD</span><span style="color:#D8DEE9FF;"> load_log_kafka </span><span style="color:#81A1C1;">ON</span><span style="color:#D8DEE9FF;"> log_db.log_table  </span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">COLUMNS(ts, clientip, request, </span><span style="color:#81A1C1;">status</span><span style="color:#D8DEE9FF;">, </span><span style="color:#81A1C1;">size</span><span style="color:#D8DEE9FF;">)  </span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">PROPERTIES (  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">max_batch_interval</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">10</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">max_batch_rows</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">1000000</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">max_batch_size</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">109715200</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">load_to_single_tablet</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">true</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">timeout</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">600</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">strict_mode</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">false</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">format</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">json</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">  </span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">)  </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">FROM</span><span style="color:#D8DEE9FF;"> KAFKA (  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">kafka_broker_list</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">host:port</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">kafka_topic</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">log__topic_</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">property.group.id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">your_group_id</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">property.security.protocol</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">SASL_PLAINTEXT</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">property.sasl.mechanism</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">GSSAPI</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">property.sasl.kerberos.service.name</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">kafka</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">property.sasl.kerberos.keytab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">/path/to/xxx.keytab</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">,  </span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">property.sasl.kerberos.principal</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">&lt;xxx@yyy.com&gt;</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">  </span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">);  </span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">-- 查看 routine 的状态  </span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">SHOW ROUTINE </span><span style="color:#81A1C1;">LOAD</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>更多关于 Kafka 配置和使用的说明，可参考 <a href="https://doris.apache.org/zh-CN/docs/data-operate/import/import-way/routine-load-manual" target="_blank" rel="noopener noreferrer">Routine Load</a>。</p><p><strong>使用自定义程序采集日志</strong></p><p>除了对接常用的日志采集器以外，你也可以自定义程序，通过 HTTP API Stream Load 将日志数据导入 Apache Doris。参考以下代码：</p><div class="language-bash line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sh" data-title="sh"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-bash;"><code><span class="line"><span class="line"><span style="color:#88C0D0;">curl</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">--location-trusted</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">-u</span><span style="color:#A3BE8C;"> username:password</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">-H</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">format:json</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">-H</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">read_json_by_line:true</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">-H</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">load_to_single_tablet:true</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">-H</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">timeout:600</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">-T</span><span style="color:#A3BE8C;"> logfile.json</span><span style="color:#D8DEE9FF;">   </span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">http://fe_host:fe_http_port/api/log_db/log_table/_stream_load</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在使用自定义程序时，需注意以下关键点：</p><ul><li>使用 Basic Auth 进行 HTTP 鉴权，用命令 <code>echo -n &#39;username:password&#39; | base64</code> 进行计算。</li><li>设置 HTTP header &quot;format:json&quot;，指定数据格式为 JSON。</li><li>设置 HTTP header &quot;read_json_by_line:true&quot;，指定每行一个 JSON。</li><li>设置 HTTP header &quot;load_to_single_tablet:true&quot;，指定一次导入写入一个分桶减少导入的小文件。</li><li>建议写入客户端一个 Batch 的大小为 100MB ～ 1GB。如果你使用的是 Apache Doris 2.1 及更高版本，需通过服务端 Group Commit 功能，降低客户端 Batch 大小。</li></ul><h3 id="第-6-步-查询和分析日志" tabindex="-1"><a class="header-anchor" href="#第-6-步-查询和分析日志"><span>第 6 步：查询和分析日志</span></a></h3><p><strong>日志查询</strong></p><p>Apache Doris 支持标准 SQL，因此，你可以通过 MySQL 客户端或者 JDBC 等方式连接到集群，执行 SQL 进行日志查询。参考以下命令：</p><div class="language-text line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="text" data-title="text"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-text;"><code><span class="line"><span class="line"><span>mysql -h fe_host -P fe_mysql_port -u your_username -Dyour_db_name</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>下方列出常见的 5 条 SQL 查询命令，以供参考：</p><ul><li>查看最新的 10 条数据</li></ul><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">SELECT</span><span style="color:#81A1C1;"> *</span><span style="color:#81A1C1;"> FROM</span><span style="color:#D8DEE9FF;"> your_table_name </span><span style="color:#81A1C1;">ORDER BY</span><span style="color:#D8DEE9FF;"> ts </span><span style="color:#81A1C1;">DESC</span><span style="color:#81A1C1;"> LIMIT</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>查询 <code>host</code> 为 <code>8.8.8.8</code> 的最新 10 条数据</li></ul><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">SELECT</span><span style="color:#81A1C1;"> *</span><span style="color:#81A1C1;"> FROM</span><span style="color:#D8DEE9FF;"> your_table_name </span><span style="color:#81A1C1;">WHERE</span><span style="color:#D8DEE9FF;"> host </span><span style="color:#81A1C1;">=</span><span style="color:#ECEFF4;"> &#39;</span><span style="color:#A3BE8C;">8.8.8.8</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#81A1C1;"> ORDER BY</span><span style="color:#D8DEE9FF;"> ts </span><span style="color:#81A1C1;">DESC</span><span style="color:#81A1C1;"> LIMIT</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><ul><li>检索请求字段中有 <code>error</code> 或者 <code>404</code> 的最新 10 条数据。其中，<code>MATCH_ANY</code> 是 Apache Doris 全文检索的 SQL 语法，用于匹配参数中任一关键字。</li></ul><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">SELECT</span><span style="color:#81A1C1;"> *</span><span style="color:#81A1C1;"> FROM</span><span style="color:#D8DEE9FF;"> your_table_name </span><span style="color:#81A1C1;">WHERE</span><span style="color:#81A1C1;"> message</span><span style="color:#D8DEE9FF;"> MATCH_ANY </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">error 404</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">  </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">ORDER BY</span><span style="color:#D8DEE9FF;"> ts </span><span style="color:#81A1C1;">DESC</span><span style="color:#81A1C1;"> LIMIT</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>检索请求字段中有 <code>image</code> 和 <code>faq</code> 的最新 10 条数据。其中，<code>MATCH_ALL</code> 是 Apache Doris 全文检索的 SQL 语法，用于匹配参数中所有关键字。</li></ul><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">SELECT</span><span style="color:#81A1C1;"> *</span><span style="color:#81A1C1;"> FROM</span><span style="color:#D8DEE9FF;"> your_table_name </span><span style="color:#81A1C1;">WHERE</span><span style="color:#81A1C1;"> message</span><span style="color:#D8DEE9FF;"> MATCH_ALL </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">image faq</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">  </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">ORDER BY</span><span style="color:#D8DEE9FF;"> ts </span><span style="color:#81A1C1;">DESC</span><span style="color:#81A1C1;"> LIMIT</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><ul><li>检索请求字段中有 <code>image</code> 和 <code>faq</code> 的最新 10 条数据。其中，<code>MATCH_PHRASE</code> 是 Apache Doris 全文检索的 SQL 语法，用于匹配参数中所有关键字，并且要求顺序一致。在下方例子中，<code>a image faq b</code> 能匹配，但是 <code>a faq image b</code> 不能匹配，因为 <code>image</code> 和 <code>faq</code> 的顺序与查询不一致。</li></ul><div class="language-sql line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="sql" data-title="sql"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-sql;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">SELECT</span><span style="color:#81A1C1;"> *</span><span style="color:#81A1C1;"> FROM</span><span style="color:#D8DEE9FF;"> your_table_name </span><span style="color:#81A1C1;">WHERE</span><span style="color:#81A1C1;"> message</span><span style="color:#D8DEE9FF;"> MATCH_PHRASE </span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">image faq</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">  </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">ORDER BY</span><span style="color:#D8DEE9FF;"> ts </span><span style="color:#81A1C1;">DESC</span><span style="color:#81A1C1;"> LIMIT</span><span style="color:#B48EAD;"> 10</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>可视化日志分析</strong></p><p>一些第三方厂商提供了基于 Apache Doris 的可视化日志分析开发平台，包含类 Kibana Discover 的日志检索分析界面，提供直观、易用的探索式日志分析交互。</p><ul><li>支持全文检索和 SQL 两种模式</li><li>支持时间框和直方图上选择查询日志的时间段</li><li>支持信息丰富的日志明细展示，还可以展开成 JSON 或表格</li><li>在日志数据上下文交互式点击增加和删除筛选条件</li><li>搜索结果的字段 Top 值展示，便于发现异常值和进一步下钻分析</li></ul>`,80)]))}const c=n(t,[["render",o],["__file","日志存储最佳实践.html.vue"]]),r=JSON.parse('{"path":"/md/article/database/doris/%E6%97%A5%E5%BF%97%E5%AD%98%E5%82%A8%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5.html","title":"","lang":"en-US","frontmatter":{},"headers":[{"level":2,"title":"操作指南","slug":"操作指南","link":"#操作指南","children":[{"level":3,"title":"第 1 步：评估资源","slug":"第-1-步-评估资源","link":"#第-1-步-评估资源","children":[]},{"level":3,"title":"第 2 步：部署集群","slug":"第-2-步-部署集群","link":"#第-2-步-部署集群","children":[]},{"level":3,"title":"第 3 步：优化 FE 和 BE 配置","slug":"第-3-步-优化-fe-和-be-配置","link":"#第-3-步-优化-fe-和-be-配置","children":[]},{"level":3,"title":"第 4 步：建表","slug":"第-4-步-建表","link":"#第-4-步-建表","children":[]},{"level":3,"title":"第 5 步：采集日志","slug":"第-5-步-采集日志","link":"#第-5-步-采集日志","children":[]},{"level":3,"title":"第 6 步：查询和分析日志","slug":"第-6-步-查询和分析日志","link":"#第-6-步-查询和分析日志","children":[]}]}],"git":{"updatedTime":1512273600000,"contributors":[{"name":"hyfly233","username":"hyfly233","email":"hyfly233@outlook.com","commits":2,"url":"https://github.com/hyfly233"}]},"filePathRelative":"md/article/database/doris/日志存储最佳实践.md"}');export{c as comp,r as data};
