<!doctype html>
<html lang="en-US">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-rc.19" />
    <style>
      :root {
        --vp-c-bg: #fff;
      }

      [data-theme='dark'] {
        --vp-c-bg: #1b1b1f;
      }

      html,
      body {
        background-color: var(--vp-c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme')
      const systemDarkMode =
        'matchMedia' in window
          ? window.matchMedia('(prefers-color-scheme: dark)').matches
          : false

      if (userMode === 'light') {
        document.documentElement.dataset.theme = 'light'
      } else if (userMode === 'dark' || systemDarkMode) {
        document.documentElement.dataset.theme = 'dark'
      }
    </script>
    <title>分布式锁 | とんぼの気持ち</title><meta name="description" content="">
    <link rel="preload" href="/blog/assets/style-nxaj3WOG.css" as="style"><link rel="stylesheet" href="/blog/assets/style-nxaj3WOG.css">
    <link rel="modulepreload" href="/blog/assets/app-chPKMbRn.js"><link rel="modulepreload" href="/blog/assets/分布式锁.html-CgINm6oC.js">
    <link rel="prefetch" href="/blog/assets/directory.html-CM077g0X.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-WkqGtERh.js" as="script"><link rel="prefetch" href="/blog/assets/directory.html-BH0WGkAw.js" as="script"><link rel="prefetch" href="/blog/assets/CephAnsible扩充OSD节点.html-DQGhyA8S.js" as="script"><link rel="prefetch" href="/blog/assets/CephAnsible的OSD存储满后的临时解决方案.html-BDuF8Lky.js" as="script"><link rel="prefetch" href="/blog/assets/CephAnsible部署Ceph.html-B1ua_UqN.js" as="script"><link rel="prefetch" href="/blog/assets/iSCSI安装.html-HVTL7fJU.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BceON7lL.js" as="script"><link rel="prefetch" href="/blog/assets/如何升级系统构架.html-B16ubYTA.js" as="script"><link rel="prefetch" href="/blog/assets/如何正确加锁.html-DjvlAowS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C3nYQ7aQ.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BmNefUmR.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DJsvdjYt.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BlgG4jCN.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bp1xrcuH.js" as="script"><link rel="prefetch" href="/blog/assets/linear_search.html-Dr3lRrFe.js" as="script"><link rel="prefetch" href="/blog/assets/binary_tree_sort.html-BZSaHXpo.js" as="script"><link rel="prefetch" href="/blog/assets/bitonic_sort.html-DZHRyZF8.js" as="script"><link rel="prefetch" href="/blog/assets/bubble_sort.html-XLBBj8rD.js" as="script"><link rel="prefetch" href="/blog/assets/bucket_sort.html-D1NDEl5q.js" as="script"><link rel="prefetch" href="/blog/assets/cocktail_shaker_sort.html-sQF3C84o.js" as="script"><link rel="prefetch" href="/blog/assets/comb_sort.html-B6Z7wIqt.js" as="script"><link rel="prefetch" href="/blog/assets/counting_sort.html-D8wkfUEd.js" as="script"><link rel="prefetch" href="/blog/assets/gnome_sort.html-ClFIwPrf.js" as="script"><link rel="prefetch" href="/blog/assets/heap_sort.html-Rp3rKaBj.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DSXsiBgb.js" as="script"><link rel="prefetch" href="/blog/assets/insertion_sort.html-Cb45Fk0s.js" as="script"><link rel="prefetch" href="/blog/assets/merge_sort.html-DKhyfHNj.js" as="script"><link rel="prefetch" href="/blog/assets/odd_even_sort.html-BUUtGCfM.js" as="script"><link rel="prefetch" href="/blog/assets/pancake_sort.html-CLbqQfeK.js" as="script"><link rel="prefetch" href="/blog/assets/quick_sort.html-DsTl6rI_.js" as="script"><link rel="prefetch" href="/blog/assets/radix_sort.html-DGfsIMQr.js" as="script"><link rel="prefetch" href="/blog/assets/selection_sort.html-CWB7HCPo.js" as="script"><link rel="prefetch" href="/blog/assets/shell_sort.html-RYeqqTj9.js" as="script"><link rel="prefetch" href="/blog/assets/smooth_sort.html-B0t6JSLd.js" as="script"><link rel="prefetch" href="/blog/assets/stooge_sort.html-YfhFB3iG.js" as="script"><link rel="prefetch" href="/blog/assets/tim_sort.html-BoCSzhxx.js" as="script"><link rel="prefetch" href="/blog/assets/ESXI虚机迁移至OpenStack.html-6EM4grfG.js" as="script"><link rel="prefetch" href="/blog/assets/Kolla使用Libvirt.html-BH6Q3PvO.js" as="script"><link rel="prefetch" href="/blog/assets/Kolla及Ceph部署.html-DBRpVcxj.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BlM2okaw.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DuySOOS7.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-COYjVXza.js" as="script"><link rel="prefetch" href="/blog/assets/环境搭建.html-BwslABub.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bk5wCQBA.js" as="script"><link rel="prefetch" href="/blog/assets/Schema变更.html-CmXDyeR-.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bl4wowJu.js" as="script"><link rel="prefetch" href="/blog/assets/动态分区和RoutineLoad.html-BYzTxZd0.js" as="script"><link rel="prefetch" href="/blog/assets/存算分离.html-9GVDpuqQ.js" as="script"><link rel="prefetch" href="/blog/assets/数据划分.html-yeEAwxQ-.js" as="script"><link rel="prefetch" href="/blog/assets/数据库建表最佳实践.html-CU31WBJ2.js" as="script"><link rel="prefetch" href="/blog/assets/日志存储最佳实践.html-BJPmJmHB.js" as="script"><link rel="prefetch" href="/blog/assets/表模型.html-lvuDP8dJ.js" as="script"><link rel="prefetch" href="/blog/assets/表索引.html-Ck9S3vCk.js" as="script"><link rel="prefetch" href="/blog/assets/表设计.html-tk_DoCsV.js" as="script"><link rel="prefetch" href="/blog/assets/集群部署.html-4idh13Cl.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Cth5DVaR.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ZicgUK5U.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DoXHiDiT.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CrHNcY8F.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CUx8GfJe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BHVKGkTF.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-COz27HnP.js" as="script"><link rel="prefetch" href="/blog/assets/query.html-DoPeGCPi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-w3kLOssO.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DTpqBRxQ.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BxORDID2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-k7IOKuSo.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-CQB9Z0b8.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-EtRq-J4i.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-JVp3vOGH.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DQBe6C8G.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BHiZJrZY.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DIai_jYU.js" as="script"><link rel="prefetch" href="/blog/assets/TerraformFramework实现Provider.html-DmR-BbHm.js" as="script"><link rel="prefetch" href="/blog/assets/Terraform命令.html-CSe_xkG9.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-B-1hZwCU.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DCKXXjZh.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C0awBswM.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Wn39Nn3s.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bzvj5tms.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BE5TLZ79.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-BH9xzrDi.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-fENjPdqb.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-DBCYo0z6.js" as="script"><link rel="prefetch" href="/blog/assets/Rsyslog日志转存.html-VynoGpA4.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-49epSqc8.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-B_flGDt0.js" as="script"><link rel="prefetch" href="/blog/assets/SeaTunnel数据库CDC配置.html-ON8CoGPS.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-ChXgdJTg.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Bc5oNQiy.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-B-dcPYv2.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-Ck1dZsqe.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-3t4G-zts.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-KRPZcEBU.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-RQaezZK1.js" as="script"><link rel="prefetch" href="/blog/assets/ZabbixAgent安装及自定义脚本.html-DKURZalB.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C29L2VNh.js" as="script"><link rel="prefetch" href="/blog/assets/zabbix安装.html-FEQL6thK.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-R3ii_NIK.js" as="script"><link rel="prefetch" href="/blog/assets/index.html-C5_B4zlm.js" as="script"><link rel="prefetch" href="/blog/assets/SQL.html-89x0k9Cm.js" as="script"><link rel="prefetch" href="/blog/assets/数据库优化.html-K6nWNgZK.js" as="script"><link rel="prefetch" href="/blog/assets/数据库索引.html-BX4K5xTn.js" as="script"><link rel="prefetch" href="/blog/assets/数据库锁与事务.html-CS8d_ANn.js" as="script"><link rel="prefetch" href="/blog/assets/Mybatis.html-CIkBxdDk.js" as="script"><link rel="prefetch" href="/blog/assets/Java基础.html-D_QRBbpt.js" as="script"><link rel="prefetch" href="/blog/assets/Java调优.html-B4RoEDf7.js" as="script"><link rel="prefetch" href="/blog/assets/Java进阶.html-Db99JmhM.js" as="script"><link rel="prefetch" href="/blog/assets/反射.html-B9fatXTn.js" as="script"><link rel="prefetch" href="/blog/assets/线程池.html-CxbSCpUd.js" as="script"><link rel="prefetch" href="/blog/assets/锁.html-B6SpjkfJ.js" as="script"><link rel="prefetch" href="/blog/assets/集合.html-CUZ1m7It.js" as="script"><link rel="prefetch" href="/blog/assets/面向对象.html-UMaUbHDD.js" as="script"><link rel="prefetch" href="/blog/assets/jvm.html-BWNS3e3B.js" as="script"><link rel="prefetch" href="/blog/assets/JUC.html-DLUivWNX.js" as="script"><link rel="prefetch" href="/blog/assets/ThreadLocal.html-BYxYh7yT.js" as="script"><link rel="prefetch" href="/blog/assets/多线程.html-BmpsxTLI.js" as="script"><link rel="prefetch" href="/blog/assets/线程池.html-DwozZdb4.js" as="script"><link rel="prefetch" href="/blog/assets/锁.html--5qDdUfD.js" as="script"><link rel="prefetch" href="/blog/assets/Redis.html-BsKKSiRX.js" as="script"><link rel="prefetch" href="/blog/assets/ElasticSearch.html-Pn1J3Cur.js" as="script"><link rel="prefetch" href="/blog/assets/JVM.html-DNvsmY-J.js" as="script"><link rel="prefetch" href="/blog/assets/JVM内存模型.html-CZyniu0B.js" as="script"><link rel="prefetch" href="/blog/assets/JVM对高效并发的支持.html-eb1cM9Dq.js" as="script"><link rel="prefetch" href="/blog/assets/JVM工具和JVM调优.html--xINkAvq.js" as="script"><link rel="prefetch" href="/blog/assets/垃圾回收.html-WnvI2chO.js" as="script"><link rel="prefetch" href="/blog/assets/Spring.html-B4O33Fe1.js" as="script"><link rel="prefetch" href="/blog/assets/SpringBoot.html-O44ccL2x.js" as="script"><link rel="prefetch" href="/blog/assets/SpringMvc.html-C8kgBqP7.js" as="script"><link rel="prefetch" href="/blog/assets/SpringCloud.html-DTSK6rgN.js" as="script"><link rel="prefetch" href="/blog/assets/SpringCloudAlibaba.html-BXlIalpv.js" as="script"><link rel="prefetch" href="/blog/assets/SpringCloudNetflix.html-BP0KK0nB.js" as="script"><link rel="prefetch" href="/blog/assets/Zookeeper.html-BlOTU2g8.js" as="script"><link rel="prefetch" href="/blog/assets/分布式事务.html-BphbxoLK.js" as="script"><link rel="prefetch" href="/blog/assets/404.html-5cdhF5yj.js" as="script"><link rel="prefetch" href="/blog/assets/setupDevtools-7MC2TMWH-CYpgxpoD.js" as="script">
  </head>
  <body>
    <div id="app"><!--[--><div class="vp-theme-container external-link-icon" vp-container><!--[--><header class="vp-navbar" vp-navbar><div class="vp-toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a class="route-link" href="/blog/"><img class="vp-site-logo" src="/blog/assets/img/game.ico" alt="とんぼの気持ち"><span class="vp-site-name vp-hide-mobile" aria-hidden="true">とんぼの気持ち</span></a></span><div class="vp-navbar-items-wrapper" style=""><!--[--><!--]--><nav class="vp-navbar-items vp-hide-mobile" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="八股文"><span class="title">八股文</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="八股文"><span class="title">八股文</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>Spring Cloud</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/SpringCloud.html" aria-label="Spring Cloud"><!---->Spring Cloud<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/SpringCloudAlibaba.html" aria-label="Spring Cloud Alibaba"><!---->Spring Cloud Alibaba<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/SpringCloudNetflix.html" aria-label="Spring Cloud Netflix"><!---->Spring Cloud Netflix<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>Zookeeper</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/Zookeeper.html" aria-label="Zookeeper"><!---->Zookeeper<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>分布式锁</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/分布式锁.html" aria-label="分布式锁"><!---->分布式锁<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>分布式事务</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/分布式事务.html" aria-label="分布式事务"><!---->分布式事务<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/hyfly233/blog" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><button type="button" class="vp-toggle-color-mode-button" title="toggle color mode"><svg class="light-icon" viewbox="0 0 32 32" style=""><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg class="dark-icon" viewbox="0 0 32 32" style="display:none;"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><form class="search-box" role="search"><input type="search" autocomplete="off" spellcheck="false" value><!----></form></div></header><!--]--><div class="vp-sidebar-mask"></div><!--[--><aside class="vp-sidebar" vp-sidebar><nav class="vp-navbar-items" aria-label="site navigation"><!--[--><div class="vp-navbar-item"><a class="route-link auto-link" href="/blog/" aria-label="Home"><!---->Home<!----></a></div><div class="vp-navbar-item"><div class="vp-navbar-dropdown-wrapper"><button class="vp-navbar-dropdown-title" type="button" aria-label="八股文"><span class="title">八股文</span><span class="arrow down"></span></button><button class="vp-navbar-dropdown-title-mobile" type="button" aria-label="八股文"><span class="title">八股文</span><span class="right arrow"></span></button><ul style="display:none;" class="vp-navbar-dropdown"><!--[--><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>Spring Cloud</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/SpringCloud.html" aria-label="Spring Cloud"><!---->Spring Cloud<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/SpringCloudAlibaba.html" aria-label="Spring Cloud Alibaba"><!---->Spring Cloud Alibaba<!----></a></li><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/SpringCloudNetflix.html" aria-label="Spring Cloud Netflix"><!---->Spring Cloud Netflix<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>Zookeeper</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/Zookeeper.html" aria-label="Zookeeper"><!---->Zookeeper<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>分布式锁</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/分布式锁.html" aria-label="分布式锁"><!---->分布式锁<!----></a></li><!--]--></ul><!--]--></li><li class="vp-navbar-dropdown-item"><!--[--><h4 class="vp-navbar-dropdown-subtitle"><span>分布式事务</span></h4><ul class="vp-navbar-dropdown-subitem-wrapper"><!--[--><li class="vp-navbar-dropdown-subitem"><a class="route-link auto-link" href="/blog/md/微服务/分布式事务.html" aria-label="分布式事务"><!---->分布式事务<!----></a></li><!--]--></ul><!--]--></li><!--]--></ul></div></div><div class="vp-navbar-item"><a class="auto-link external-link" href="https://github.com/hyfly233/blog" aria-label="GitHub" rel="noopener noreferrer" target="_blank"><!---->GitHub<!----></a></div><!--]--></nav><!--[--><!--]--><ul class="vp-sidebar-items"><!--[--><li><p tabindex="0" class="vp-sidebar-item vp-sidebar-heading">分布式锁 <!----></p><!----></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="vp-page"><!--[--><!--]--><div class="theme-default-content" vp-content><!--[--><!--]--><div><h1 id="分布式锁" tabindex="-1"><a class="header-anchor" href="#分布式锁"><span>分布式锁</span></a></h1><h2 id="分布式锁主流方案" tabindex="-1"><a class="header-anchor" href="#分布式锁主流方案"><span>分布式锁主流方案</span></a></h2><ul><li>基于数据库</li><li>基于 Redis</li><li>基于 Zookeeper</li><li>etcd</li><li>consul</li></ul><ol><li>基于ZooKeeper的分布式锁，适用于高可靠（高可用）而并发量不是太大的场景；</li><li>基于Redis的分布式锁，适用于并发量很大、性能要求很高的、而可靠性问题可以通过其他方案去弥补的场景。</li></ol><h2 id="分布式锁场景" tabindex="-1"><a class="header-anchor" href="#分布式锁场景"><span>分布式锁场景</span></a></h2><ul><li>商城秒杀</li><li>抢优惠券</li><li>接口幂等性校验</li></ul><h2 id="redis实现分布式锁的7种方案" tabindex="-1"><a class="header-anchor" href="#redis实现分布式锁的7种方案"><span>Redis实现分布式锁的7种方案</span></a></h2><ul><li>方案一：SETNX + EXPIRE</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;">（</span><span style="color:#D8DEE9;">jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setnx</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;">lock_value</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> ==</span><span style="color:#B48EAD;"> 1</span><span style="color:#D8DEE9FF;">）</span><span style="color:#ECEFF4;">{</span><span style="color:#616E88;"> //加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    expire（key_resource_id，</span><span style="color:#B48EAD;">100</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //设置过期时间</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        //业务请求</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">del</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>setnx 和 expire 两个命令分开，不是原子操作，如果执行完 setnx 操作后进程挂掉，那么锁将会一直存在，其他线程永远获取不了锁</p><ul><li>方案二：SETNX + value值是（系统时间+过期时间）</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">long</span><span style="color:#D8DEE9;"> expires</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentTimeMillis</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> expireTime</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> //系统时间 + 过期时间</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> expiresStr</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> String</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">valueOf</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">expires</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">// 如果当前锁不存在，返回加锁成功</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">setnx</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> expiresStr</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> ==</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#D8DEE9FF;"> </span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">// 如果锁已经存在，获取锁的过期时间</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> currentValueStr</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">// 如果获取到的过期时间，小于系统当前时间，表示已经过期</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">currentValueStr </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#81A1C1;"> &amp;&amp;</span><span style="color:#D8DEE9;"> Long</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">parseLong</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">currentValueStr</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> &lt;</span><span style="color:#D8DEE9;"> System</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentTimeMillis</span><span style="color:#ECEFF4;">())</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 锁已过期，获取上一个锁的过期时间，并设置现在锁的过期时间</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    String</span><span style="color:#D8DEE9;"> oldValueStr</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getSet</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> expiresStr</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">oldValueStr </span><span style="color:#81A1C1;">!=</span><span style="color:#81A1C1;"> null</span><span style="color:#81A1C1;"> &amp;&amp;</span><span style="color:#D8DEE9;"> oldValueStr</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">currentValueStr</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 考虑多线程并发的情况，只有一个线程的设置值和当前值相同，它才可以加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">//其他情况，均返回加锁失败</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">return</span><span style="color:#81A1C1;"> false;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><ul><li>过期时间是客户端生成的，在分布式环境中需要保障每个客户端的时间同步</li><li>jedis.getSet 可能出现锁覆盖的情况</li></ul></li><li><p>方案三：使用Lua脚本(包含SETNX + EXPIRE两条指令)</p></li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9;"> lua_scripts</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">if redis.call(&#39;setnx&#39;,KEYS[1],ARGV[1]) == 1 then</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    &quot;</span><span style="color:#A3BE8C;"> redis.call(&#39;expire&#39;,KEYS[1],ARGV[2]) return 1 else return 0 end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">Object</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">eval</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lua_scripts</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> Collections</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">singletonList</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">),</span><span style="color:#D8DEE9;"> Collections</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">singletonList</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">values</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">//判断是否成功</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">return</span><span style="color:#D8DEE9;"> result</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1L</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>方案四：SET的扩展命令（SET EX PX NX）</p></li><li><ul><li><strong>SET key value [EX seconds] [PX milliseconds] [NX|XX]</strong></li><li>**NX：**表示key不存在的时候，才能set成功，也即保证只有第一个客户端请求才能获得锁，而其他客户端请求只能等其释放锁，才能获取</li><li>**EX seconds：**设定key的过期时间，时间单位是秒</li><li>**PX milliseconds：**设定key的过期时间，单位为毫秒</li><li>**XX：**仅当key存在时设置值</li></ul></li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">RequestMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/test</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">(){</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    String</span><span style="color:#D8DEE9;"> lockKey</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">product_001</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;">{</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">        Boolean</span><span style="color:#D8DEE9;"> result</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> stringRedisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">()</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">setIfAbsent</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lockKey</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">testlock</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#B48EAD;"> 10</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> TimeUnit</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">SECONDS</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;">(</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9FF;">result</span><span style="color:#ECEFF4;">){</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            // 代表已经加锁了</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">error_code</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 从redis 中拿当前库存的值</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        int</span><span style="color:#D8DEE9;"> stock</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Integer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">parseInt</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stringRedisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stock</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">stock </span><span style="color:#81A1C1;">&gt;</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">){</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            int</span><span style="color:#D8DEE9;"> realStock</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> stock </span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            stringRedisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">set</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stock</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> realStock </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">扣减成功，剩余库存：</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> realStock</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;">else</span><span style="color:#ECEFF4;">{</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">扣减失败，库存不足</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        stringRedisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">delete</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lockKey</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><ul><li>存在超时时间过短，业务代码未执行完的情况</li><li>锁被其他线程误删。线程a执行完后，去释放锁。但是它不知道当前的锁可能是线程b持有的（线程a去释放锁时，有可能过期时间已经到了，此时线程b进来占有了锁）。那线程a就把线程b的锁释放掉了，但是线程b临界区业务代码可能都还没执行完呢</li></ul></li><li><p>方案五：SET EX PX NX + 校验唯一随机值，再释放锁</p></li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;">（</span><span style="color:#D8DEE9;">jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">set</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> uni_request_id</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">NX</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">EX</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> 100s</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> ==</span><span style="color:#B48EAD;"> 1</span><span style="color:#D8DEE9FF;">）</span><span style="color:#ECEFF4;">{</span><span style="color:#616E88;"> //加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 业务处理</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;">catch</span><span style="color:#ECEFF4;">(){</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    finally</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 判断是不是当前线程加的锁,是才释放，非原子</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">uni_request_id</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">key_resource_id</span><span style="color:#ECEFF4;">)))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            jedis</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">del</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lockKey</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span><span style="color:#616E88;"> // 释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了更严谨，一般也是用lua脚本代替</p><div class="language-lua line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-lua;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9;"> redis</span><span style="color:#D8DEE9FF;">.</span><span style="color:#88C0D0;">call</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">get</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">,</span><span style="color:#D8DEE9;">KEYS</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]) </span><span style="color:#81A1C1;">==</span><span style="color:#D8DEE9;"> ARGV</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">] </span><span style="color:#81A1C1;">then</span><span style="color:#D8DEE9FF;"> </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#D8DEE9;"> redis</span><span style="color:#D8DEE9FF;">.</span><span style="color:#88C0D0;">call</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">del</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">,</span><span style="color:#D8DEE9;">KEYS</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]) </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">else</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  return</span><span style="color:#B48EAD;"> 0</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">end</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><p>方案六：单机分布式锁 Redisson</p></li><li><p>方案七：多机分布式锁 Redlock + Redisson</p></li></ul><h3 id="单机redisson分布式锁" tabindex="-1"><a class="header-anchor" href="#单机redisson分布式锁"><span>单机Redisson分布式锁</span></a></h3><h4 id="引入依赖" tabindex="-1"><a class="header-anchor" href="#引入依赖"><span>引入依赖</span></a></h4><div class="language-xml line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="xml" data-title="xml"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-xml;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">&lt;dependency&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  &lt;groupId&gt;</span><span style="color:#D8DEE9FF;">org.redisson</span><span style="color:#81A1C1;">&lt;/groupId&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  &lt;artifactId&gt;</span><span style="color:#D8DEE9FF;">redisson</span><span style="color:#81A1C1;">&lt;/artifactId&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">  &lt;version&gt;</span><span style="color:#D8DEE9FF;">xxx</span><span style="color:#81A1C1;">&lt;/version&gt;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">&lt;/dependency&gt;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="初始化客户端" tabindex="-1"><a class="header-anchor" href="#初始化客户端"><span>初始化客户端</span></a></h4><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Bean</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#8FBCBB;"> RedissonClient</span><span style="color:#88C0D0;"> redisson</span><span style="color:#ECEFF4;">(){</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 单机模式</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    Config</span><span style="color:#D8DEE9;"> config</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Config</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    config</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">useSingleServer</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">setAddress</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">redis://127.0.0.1:6379</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">setDatabase</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#D8DEE9;"> Redisson</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">config</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="实现分布式锁" tabindex="-1"><a class="header-anchor" href="#实现分布式锁"><span>实现分布式锁</span></a></h4><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">RestController</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> IndexController</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Autowired</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> RedissonClient</span><span style="color:#D8DEE9;"> redisson</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Autowired</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> StringRedisTemplate</span><span style="color:#D8DEE9;"> stringRedisTemplate</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    /**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * 模拟下单减库存的场景</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * </span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * </span><span style="color:#8FBCBB;">@return</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     */</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">RequestMapping</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">value</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/test</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> test</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">        String</span><span style="color:#D8DEE9;"> lockKey</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">product_001</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        // 1.获取锁对象</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">        RLock</span><span style="color:#D8DEE9;"> redissonLock</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redisson</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lockKey</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            // 2.加锁  等价于 setIfAbsent(lockKey,&quot;testlock&quot;,10,TimeUnit.SECONDS);</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            redissonLock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">lock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            // 从redis 中拿当前库存的值</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            int</span><span style="color:#D8DEE9;"> stock</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Integer</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">parseInt</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">stringRedisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stock</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">))</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">stock </span><span style="color:#81A1C1;">&gt;</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                int</span><span style="color:#D8DEE9;"> realStock</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> stock </span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                stringRedisTemplate</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">opsForValue</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">set</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">stock</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> realStock </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">扣减成功，剩余库存：</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> realStock</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">扣减失败，库存不足</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            // 3.释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            redissonLock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">end</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>Redisson的lock方法最终执行的是 lua 脚本</p><div class="language-lua line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="lua" data-title="lua"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-lua;"><code><span class="line"><span class="line"><span style="color:#616E88;">-- exists 判断 key 是否存在</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">if</span><span style="color:#D8DEE9FF;"> (</span><span style="color:#D8DEE9;">redis</span><span style="color:#D8DEE9FF;">.</span><span style="color:#88C0D0;">call</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">exists</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#D8DEE9;">KEYS</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]) </span><span style="color:#81A1C1;">==</span><span style="color:#B48EAD;"> 0</span><span style="color:#D8DEE9FF;">) </span><span style="color:#81A1C1;">then</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    -- 设置 key</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    redis</span><span style="color:#D8DEE9FF;">.</span><span style="color:#88C0D0;">call</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">hset</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#D8DEE9;">KEYS</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">], </span><span style="color:#D8DEE9;">ARGV</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">2</span><span style="color:#D8DEE9FF;">], </span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">);</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    -- 追加过期时间</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    redis</span><span style="color:#D8DEE9FF;">.</span><span style="color:#88C0D0;">call</span><span style="color:#D8DEE9FF;">(</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#A3BE8C;">pexpire</span><span style="color:#ECEFF4;">&#39;</span><span style="color:#D8DEE9FF;">, </span><span style="color:#D8DEE9;">KEYS</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">], </span><span style="color:#D8DEE9;">ARGV</span><span style="color:#D8DEE9FF;">[</span><span style="color:#B48EAD;">1</span><span style="color:#D8DEE9FF;">]); </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> nil</span><span style="color:#D8DEE9FF;">; </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">end</span><span style="color:#D8DEE9FF;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>lua 脚本在 redis 中执行时，会被当做一条命令，所以能够保证原子性，Redisson中大量使用了lua脚本</p><h3 id="多机分布式锁-redlock-redisson" tabindex="-1"><a class="header-anchor" href="#多机分布式锁-redlock-redisson"><span>多机分布式锁 Redlock + Redisson</span></a></h3><p><strong>org.redisson.RedissonMultiLock</strong> 对象可实现 Redlock 锁算法，将多个 RLock 对象划分为一组并且将它们当做一个锁来处理，每个 RLock 对象可以属于不同的 Redisson 实例</p><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#8FBCBB;">RLock</span><span style="color:#D8DEE9;"> lock1</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redissonInstance1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">lock1</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RLock</span><span style="color:#D8DEE9;"> lock2</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redissonInstance2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">lock2</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RLock</span><span style="color:#D8DEE9;"> lock3</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redissonInstance3</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">lock3</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RedissonMultiLock</span><span style="color:#D8DEE9;"> lock</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> RedissonMultiLock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lock1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> lock2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> lock3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">// locks: lock1 lock2 lock3</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">lock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">lock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">...</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">lock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>RedissonRedLock extends</strong> <strong>RedissonMultiLock</strong></p><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#8FBCBB;">Config</span><span style="color:#D8DEE9;"> config1</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Config</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">config1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">useSingleServer</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">setAddress</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">redis://172.0.0.1:5378</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">setDatabase</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RedissonClient</span><span style="color:#D8DEE9;"> redissonClient1</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Redisson</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">config1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">Config</span><span style="color:#D8DEE9;"> config2</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Config</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">config2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">useSingleServer</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">setAddress</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">redis://172.0.0.1:5379</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">setDatabase</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RedissonClient</span><span style="color:#D8DEE9;"> redissonClient2</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Redisson</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">config2</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">Config</span><span style="color:#D8DEE9;"> config3</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Config</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">config3</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">useSingleServer</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">setAddress</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">redis://172.0.0.1:5380</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">setDatabase</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RedissonClient</span><span style="color:#D8DEE9;"> redissonClient3</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Redisson</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">create</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">config3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">/**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">* 获取多个 RLock 对象</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">*/</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RLock</span><span style="color:#D8DEE9;"> lock1</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redissonInstance1</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">lockKey</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RLock</span><span style="color:#D8DEE9;"> lock2</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redissonInstance2</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">lockKey</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RLock</span><span style="color:#D8DEE9;"> lock3</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redissonInstance3</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getLock</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">lockKey</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">/**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">* 根据多个 RLock 对象构建 RedissonRedLock</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">*/</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">RedissonRedLock</span><span style="color:#D8DEE9;"> lock</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> RedissonRedLock</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">lock1</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> lock2</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> lock3</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    /**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    * 尝试获取锁</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    * waitTimeout 尝试获取锁的最大等待时间，超过这个值，则认为获取锁失败</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    * leaseTime   锁的持有时间，超过这个时间锁会自动失效（值应设置为大于业务处理的时间，确保在锁有效期内业务能处理完）</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    */</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    boolean</span><span style="color:#D8DEE9;"> res</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> redLock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">tryLock</span><span style="color:#ECEFF4;">((</span><span style="color:#81A1C1;">long</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;">waitTimeout</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">long</span><span style="color:#ECEFF4;">)</span><span style="color:#D8DEE9FF;">leaseTime</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> TimeUnit</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">SECONDS</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">res</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        //成功获得锁，在这里处理业务</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> RuntimeException</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">aquire lock fail</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span><span style="color:#81A1C1;"> finally</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //解锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    redLock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="zookeeper分布式锁" tabindex="-1"><a class="header-anchor" href="#zookeeper分布式锁"><span>Zookeeper分布式锁</span></a></h2><p>ZooKeeper实现的分布式锁，性能并不太高，在高性能高并发的场景下不建议使用分布式锁</p><h3 id="三种方案" tabindex="-1"><a class="header-anchor" href="#三种方案"><span>三种方案</span></a></h3><ul><li>临时节点方案：缺点是每次竞争锁，都只有一个线程拿到锁，会导致大量线程同时阻塞抢锁，性能低甚至宕机</li><li>临时顺序节点方案：临时顺序节点与临时节点不同的是产生的节点是有序的</li><li>Curator分布式锁工具中的共享可重入锁：全局同步锁，在同一时间不会有两个客户端持有一个锁</li></ul><h3 id="临时顺序节点方案" tabindex="-1"><a class="header-anchor" href="#临时顺序节点方案"><span>临时顺序节点方案</span></a></h3><p><strong>排队取号</strong></p><p><strong>公平可重入锁</strong>，<strong>Zookeeper临时顺序节点</strong>，递增有序性，可以确保锁的公平，节点监听机制，可以保障占有锁的传递有序而且高效</p><p>分布式锁的算法</p><ul><li>一把分布式锁通常使用一个Znode节点表示；如果锁对应的Znode节点不存在，首先创建Znode节点。这里假设为“/test/lock”，代表了一把需要创建的分布式锁</li><li>抢占锁的所有客户端，使用锁的Znode节点的子节点列表来表示；如果某个客户端需要占用锁，则在“/test/lock”下创建一个临时有序的子节点。所有临时有序子节点，尽量共用一个有意义的子节点前缀。比如“/test/lock/seq-”</li><li>判定客户端是否占有锁，客户端创建子节点后，需要进行判断：自己创建的子节点，是否为当前子节点列表中序号最小的子节点。如果是，则认为加锁成功；如果不是，则监听前一个Znode子节点变更消息，等待前一个节点释放锁。</li><li>一旦队列中的后面的节点，获得前一个子节点变更通知，则开始进行判断，判断自己是否为当前子节点列表中序号最小的子节点，如果是，则认为加锁成功；如果不是，则持续监听，一直到获得锁。</li><li>获取锁后，开始处理业务流程。完成业务流程后，删除自己的对应的子节点，完成释放锁的工作，以方面后继节点能捕获到节点变更通知，获得分布式锁。</li></ul><h4 id="lock接口" tabindex="-1"><a class="header-anchor" href="#lock接口"><span>Lock接口</span></a></h4><p>定义了一个锁的接口Lock，两个抽象方法：一个加锁方法，一个解锁方法</p><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> interface</span><span style="color:#8FBCBB;"> Lock</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    /**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * 加锁方法</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     *</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * </span><span style="color:#8FBCBB;">@return</span><span style="color:#616E88;"> 是否成功加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     */</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    boolean</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> throws</span><span style="color:#8FBCBB;"> Exception</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    /**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * 解锁方法</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     *</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     * </span><span style="color:#8FBCBB;">@return</span><span style="color:#616E88;"> 是否成功解锁</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">     */</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    boolean</span><span style="color:#88C0D0;"> unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="锁实现" tabindex="-1"><a class="header-anchor" href="#锁实现"><span>锁实现</span></a></h4><p><strong>lock()</strong></p><ul><li>首先尝试着去加锁，如果加锁失败就去等待，然后再重复</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> class</span><span style="color:#8FBCBB;"> ZkLock</span><span style="color:#81A1C1;"> implements</span><span style="color:#8FBCBB;font-weight:bold;"> Lock</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //ZkLock的节点链接</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> ZK_PATH</span><span style="color:#81A1C1;"> =</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/test/lock</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> LOCK_PREFIX</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9FF;"> ZK_PATH </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#81A1C1;"> static</span><span style="color:#81A1C1;"> final</span><span style="color:#81A1C1;"> long</span><span style="color:#D8DEE9;"> WAIT_TIME</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 1000</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    </span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //Zk客户端</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    CuratorFramework</span><span style="color:#D8DEE9;"> client</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> null;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> locked_short_path</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> null;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> locked_path</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> null;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> String</span><span style="color:#D8DEE9;"> prior_path</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> null;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    final</span><span style="color:#8FBCBB;"> AtomicInteger</span><span style="color:#D8DEE9;"> lockCount</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> AtomicInteger</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    </span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    private</span><span style="color:#8FBCBB;"> Thread</span><span style="color:#D8DEE9;"> thread</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#88C0D0;"> ZkLock</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">init</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isNodeExist</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">ZK_PATH</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">createNode</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">ZK_PATH</span><span style="color:#ECEFF4;">,</span><span style="color:#81A1C1;"> null</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        client </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClient</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    @</span><span style="color:#D08770;">Override</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    public</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">		//可重入，确保同一线程，可以重复加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> ==</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">                thread </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">incrementAndGet</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">()))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                    return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">                }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">incrementAndGet</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            boolean</span><span style="color:#D8DEE9;"> locked</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">			//首先尝试着去加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">            locked </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> tryLock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">locked</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            //如果加锁失败就去等待</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            while</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9FF;">locked</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">                await</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                //获取等待的子节点列表</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">                List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> waiters</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getWaiters</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">				//判断，是否加锁成功</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                if</span><span style="color:#ECEFF4;"> (</span><span style="color:#88C0D0;">checkLocked</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">waiters</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">                    locked </span><span style="color:#81A1C1;">=</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">                }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#88C0D0;">            unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>tryLock()</strong></p><ul><li>创建临时顺序节点，并且保存自己的节点路径</li><li>判断是否是第一个，如果是第一个，则加锁成功。如果不是，就找到前一个Znode节点，并且保存其路径到prior_path</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#616E88;">/**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> * 尝试加锁</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> * </span><span style="color:#8FBCBB;">@return</span><span style="color:#616E88;"> 是否加锁成功</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> * </span><span style="color:#8FBCBB;">@throws</span><span style="color:#8FBCBB;"> Exception</span><span style="color:#616E88;"> 异常</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> */</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> tryLock</span><span style="color:#ECEFF4;">()</span><span style="color:#D8DEE9FF;"> throws Exception </span><span style="color:#ECEFF4;">{</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //创建临时Znode</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    locked_path </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            .</span><span style="color:#88C0D0;">createEphemeralSeqNode</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">LOCK_PREFIX</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //然后获取所有节点</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    List</span><span style="color:#ECEFF4;">&lt;</span><span style="color:#8FBCBB;">String</span><span style="color:#ECEFF4;">&gt;</span><span style="color:#D8DEE9;"> waiters</span><span style="color:#81A1C1;"> =</span><span style="color:#88C0D0;"> getWaiters</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">null</span><span style="color:#81A1C1;"> ==</span><span style="color:#D8DEE9FF;"> locked_path</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Exception</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">zk error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //取得加锁的排队编号</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    locked_short_path </span><span style="color:#81A1C1;">=</span><span style="color:#88C0D0;"> getShortPath</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">locked_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //获取等待的子节点列表，判断自己是否第一个</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#88C0D0;">checkLocked</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">waiters</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 判断自己排第几个</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#D8DEE9;"> index</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> Collections</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">binarySearch</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">waiters</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locked_short_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">index </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span><span style="color:#616E88;"> // 网络抖动，获取到的子节点列表里可能已经没有自己了</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Exception</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">节点没有找到: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> locked_short_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //如果自己没有获得锁，则要监听前一个节点</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">    prior_path </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9FF;"> ZK_PATH </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9;"> waiters</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">index </span><span style="color:#81A1C1;">-</span><span style="color:#B48EAD;"> 1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#8FBCBB;"> String</span><span style="color:#88C0D0;"> getShortPath</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">String</span><span style="color:#D8DEE9FF;"> locked_path</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#D8DEE9;"> index</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> locked_path</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">lastIndexOf</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">ZK_PATH </span><span style="color:#81A1C1;">+</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">index </span><span style="color:#81A1C1;">&gt;=</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">        index </span><span style="color:#81A1C1;">+=</span><span style="color:#D8DEE9;"> ZK_PATH</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">length</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> +</span><span style="color:#B48EAD;"> 1</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#D8DEE9FF;"> index </span><span style="color:#81A1C1;">&lt;=</span><span style="color:#D8DEE9;"> locked_path</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">length</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> ?</span><span style="color:#D8DEE9;"> locked_path</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">substring</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">index</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;"> :</span><span style="color:#ECEFF4;"> &quot;&quot;</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> null;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>checkLocked()</strong></p><ul><li>判断是否可以持有锁，当前创建的节点，是否在上一步获取到的子节点列表的第一个位置</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> checkLocked</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">List</span><span style="color:#81A1C1;">&lt;</span><span style="color:#D8DEE9FF;">String</span><span style="color:#81A1C1;">&gt;</span><span style="color:#D8DEE9FF;"> waiters</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //节点按照编号，升序排列</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    Collections</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sort</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">waiters</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    // 如果是第一个，代表自己已经获得了锁</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">locked_short_path</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">waiters</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">0</span><span style="color:#ECEFF4;">)))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        log</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">info</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">成功的获取分布式锁,节点为{}</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9FF;"> locked_short_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>await()</strong></p><ul><li>监听前一个ZNode节点（prior_path成员）的删除事件，可以使用两种监听方式</li><li>Watcher 订阅</li><li>TreeCache 订阅</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#81A1C1;">private</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> await</span><span style="color:#ECEFF4;">()</span><span style="color:#D8DEE9FF;"> throws Exception </span><span style="color:#ECEFF4;">{</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">null</span><span style="color:#81A1C1;"> ==</span><span style="color:#D8DEE9FF;"> prior_path</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Exception</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">prior_path error</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    final</span><span style="color:#8FBCBB;"> CountDownLatch</span><span style="color:#D8DEE9;"> latch</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> CountDownLatch</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //订阅比自己次小顺序节点的删除事件</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    Watcher</span><span style="color:#D8DEE9;"> w</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> Watcher</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        @</span><span style="color:#D08770;">Override</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> process</span><span style="color:#ECEFF4;">(</span><span style="color:#8FBCBB;">WatchedEvent</span><span style="color:#D8DEE9;"> watchedEvent</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            System</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">out</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">println</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">监听到的变化 watchedEvent = </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> watchedEvent</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            log</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">info</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">[WatchedEvent]节点删除</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            latch</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">countDown</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    client</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getData</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">usingWatcher</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">w</span><span style="color:#ECEFF4;">).</span><span style="color:#88C0D0;">forPath</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">prior_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">	</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">/*</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //订阅比自己次小顺序节点的删除事件</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    TreeCache treeCache = new TreeCache(client, prior_path);</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    TreeCacheListener l = new TreeCacheListener() {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        @Override</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        public void childEvent(CuratorFramework client,</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                                TreeCacheEvent event) throws Exception {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            ChildData data = event.getData();</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            if (data != null) {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                switch (event.getType()) {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                    case NODE_REMOVED:</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                        log.debug(&quot;[TreeCache]节点删除, path={}, data={}&quot;,</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                                data.getPath(), data.getData());</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                        latch.countDown();</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                        break;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                    default:</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                        break;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    };</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    treeCache.getListenable().addListener(l);</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    treeCache.start();</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">*/</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    latch</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">await</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">WAIT_TIME</span><span style="color:#ECEFF4;">,</span><span style="color:#D8DEE9;"> TimeUnit</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">SECONDS</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>可重入</strong></p><p>只需要保障同一个线程进入加锁的代码，可以重复加锁成功即可。在lock方法前面加上可重入的判断逻辑</p><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Override</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> lock</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //可重入的判断</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    synchronized</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">this</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">get</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;"> ==</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">            thread </span><span style="color:#81A1C1;">=</span><span style="color:#D8DEE9;"> Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">incrementAndGet</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span><span style="color:#81A1C1;"> else</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">()))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">incrementAndGet</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>为了变成可重入，在代码中增加了一个加锁的计数器lockCount，计算重复加锁的次数。如果是同一个线程加锁，只需要增加次数，直接返回，表示加锁成功。</p><h4 id="解锁" tabindex="-1"><a class="header-anchor" href="#解锁"><span>解锁</span></a></h4><p><strong>unLock()</strong>，表示释放锁，释放锁主要有两个工作</p><ul><li>减少重入锁的计数，如果最终的值不是0，直接返回，表示成功的释放了一次</li><li>如果计数器为0，移除Watchers监听器，并且删除创建的Znode临时节点</li></ul><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#616E88;">/**</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> * 释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> *</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> * </span><span style="color:#8FBCBB;">@return</span><span style="color:#616E88;"> 是否成功释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;"> */</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Override</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> boolean</span><span style="color:#88C0D0;"> unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">	//只有加锁的线程，能够解锁</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">!</span><span style="color:#D8DEE9;">thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">equals</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">currentThread</span><span style="color:#ECEFF4;">()))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">	//减少可重入的计数</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    int</span><span style="color:#D8DEE9;"> newLockCount</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> lockCount</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">decrementAndGet</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">	//计数不能小于0</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">newLockCount </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        throw</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> IllegalMonitorStateException</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">Lock count has gone negative for lock: </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> locked_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">	//如果计数不为0，直接返回</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9FF;">newLockCount </span><span style="color:#81A1C1;">!=</span><span style="color:#B48EAD;"> 0</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">    //删除临时节点</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        if</span><span style="color:#ECEFF4;"> (</span><span style="color:#D8DEE9;">ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">isNodeExist</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">locked_path</span><span style="color:#ECEFF4;">))</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            client</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">delete</span><span style="color:#ECEFF4;">().</span><span style="color:#88C0D0;">forPath</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">locked_path</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        }</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">        return</span><span style="color:#81A1C1;"> false;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    return</span><span style="color:#81A1C1;"> true;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="测试" tabindex="-1"><a class="header-anchor" href="#测试"><span>测试</span></a></h4><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#D8DEE9FF;">prviate </span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> count</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Test</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> testLock</span><span style="color:#ECEFF4;">()</span><span style="color:#D8DEE9FF;"> throws InterruptedException </span><span style="color:#ECEFF4;">{</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        FutureTaskScheduler</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            //创建锁</span></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">            ZkLock</span><span style="color:#D8DEE9;"> lock</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> ZkLock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            lock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">lock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">//每条线程，执行10次累加</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">//公共的资源变量累加</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">                count</span><span style="color:#81A1C1;">++;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1000</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">InterruptedException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            log</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">info</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">count = </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> count</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">            //释放锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">            lock</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">unlock</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Integer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MAX_VALUE</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="curator分布式锁interprocessmutex" tabindex="-1"><a class="header-anchor" href="#curator分布式锁interprocessmutex"><span>Curator分布式锁InterProcessMutex</span></a></h3><div class="language-java line-numbers-mode line-numbers-mode" data-highlighter="prismjs" data-ext="java" data-title="java"><pre class="shiki nord vp-code" style="background-color:#2e3440ff;color:#d8dee9ff language-java;"><code><span class="line"><span class="line"><span style="color:#D8DEE9FF;">prviate </span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> count</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">@</span><span style="color:#D08770;">Test</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">public</span><span style="color:#81A1C1;"> void</span><span style="color:#88C0D0;"> testzkMutex</span><span style="color:#ECEFF4;">()</span><span style="color:#D8DEE9FF;"> throws InterruptedException </span><span style="color:#ECEFF4;">{</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#8FBCBB;">    CuratorFramework</span><span style="color:#D8DEE9;"> client</span><span style="color:#81A1C1;"> =</span><span style="color:#D8DEE9;"> ZKclient</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">instance</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">getClient</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    final</span><span style="color:#8FBCBB;"> InterProcessMutex</span><span style="color:#D8DEE9;"> zkMutex</span><span style="color:#81A1C1;"> =</span><span style="color:#81A1C1;"> new</span><span style="color:#88C0D0;"> InterProcessMutex</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9FF;">client</span><span style="color:#ECEFF4;">,</span><span style="color:#ECEFF4;"> &quot;</span><span style="color:#A3BE8C;">/mutex</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">    for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> i</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> i</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">        FutureTaskScheduler</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">add</span><span style="color:#ECEFF4;">(()</span><span style="color:#8FBCBB;"> -&gt;</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">            try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                //获取互斥锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                zkMutex</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">acquire</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                for</span><span style="color:#ECEFF4;"> (</span><span style="color:#81A1C1;">int</span><span style="color:#D8DEE9;"> j</span><span style="color:#81A1C1;"> =</span><span style="color:#B48EAD;"> 0</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j </span><span style="color:#81A1C1;">&lt;</span><span style="color:#B48EAD;"> 10</span><span style="color:#81A1C1;">;</span><span style="color:#D8DEE9FF;"> j</span><span style="color:#81A1C1;">++</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">					//公共的资源变量累加</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9FF;">                    count</span><span style="color:#81A1C1;">++;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">                }</span></span></span>
<span class="line"><span class="line"><span style="color:#81A1C1;">                try</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                    Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#B48EAD;">1000</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">                }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">InterruptedException</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                    e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">                }</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                log</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">info</span><span style="color:#ECEFF4;">(</span><span style="color:#ECEFF4;">&quot;</span><span style="color:#A3BE8C;">count = </span><span style="color:#ECEFF4;">&quot;</span><span style="color:#81A1C1;"> +</span><span style="color:#D8DEE9FF;"> count</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#616E88;">                //释放互斥锁</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                zkMutex</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">release</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span><span style="color:#81A1C1;"> catch</span><span style="color:#ECEFF4;"> (</span><span style="color:#8FBCBB;">Exception</span><span style="color:#D8DEE9;"> e</span><span style="color:#ECEFF4;">)</span><span style="color:#ECEFF4;"> {</span></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">                e</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">printStackTrace</span><span style="color:#ECEFF4;">()</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">            }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">        })</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">    }</span></span></span>
<span class="line"><span class="line"></span></span>
<span class="line"><span class="line"><span style="color:#D8DEE9;">    Thread</span><span style="color:#ECEFF4;">.</span><span style="color:#88C0D0;">sleep</span><span style="color:#ECEFF4;">(</span><span style="color:#D8DEE9;">Integer</span><span style="color:#ECEFF4;">.</span><span style="color:#D8DEE9;">MAX_VALUE</span><span style="color:#ECEFF4;">)</span><span style="color:#81A1C1;">;</span></span></span>
<span class="line"><span class="line"><span style="color:#ECEFF4;">}</span></span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h2 id="etcd分布式锁" tabindex="-1"><a class="header-anchor" href="#etcd分布式锁"><span>etcd分布式锁</span></a></h2><p>etcd 是一个分布式键值对存储，设计用来可靠而快速的保存关键数据并提供访问，etcd分布式锁并不是etcd server对外提供一个功能api，而是基于etcd的各种特性（lease、watch、mvcc等）集成的一个工具。</p><h2 id="consul-分布式锁" tabindex="-1"><a class="header-anchor" href="#consul-分布式锁"><span>Consul 分布式锁</span></a></h2><p>Consul的分布式锁主要利用Key/Value存储API中的acquire和release操作来实现。acquire和release操作是类似Check-And-Set的操作</p></div><!--[--><!--]--></div><footer class="vp-page-meta"><div class="vp-meta-item edit-link"><a class="auto-link external-link label" href="https://github.com/hyfly233/blog/edit/main/md/interview/java/framework/springcloud/分布式锁.md" aria-label="Edit this page" rel="noopener noreferrer" target="_blank"><!--[--><svg class="edit-icon" viewbox="0 0 1024 1024"><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->Edit this page<!----></a></div><div class="vp-meta-item git-info"><div class="vp-meta-item last-updated"><span class="meta-item-label">最后更新时间: </span><!----></div><div class="vp-meta-item contributors"><span class="meta-item-label">贡献者: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: hyfly233@outlook.com">hyfly233</span><!----><!--]--><!--]--></span></div></div></footer><!----><!--[--><!--]--></main><!--]--></div><!--[--><!----><!--]--><!--]--></div>
    <script type="module" src="/blog/assets/app-chPKMbRn.js" defer></script>
  </body>
</html>
