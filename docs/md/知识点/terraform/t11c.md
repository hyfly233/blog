# 发布并发布到地形注册表

- 10分
- |
- 大地形态大地形态



经常引用这个？ [创建一个帐户](https://developer.hashicorp.com/sign-up)以书签教程。



Terraform Registry 是 HashiCorp 的 [Terraform](https://registry.terraform.io/) 提供程序和模块的公共存储库。每当您初始化 Terraform 配置时，Terraform 都会尝试从 Terraform 注册表下载必要的提供程序。注册表还托管特定于提供程序的文档。

在本教程中，您将为 Terraform 提供程序创建一个版本，该版本具有 与名为 HashiCups 的虚构咖啡店应用程序的 API 交互。 然后，您将演练将提供程序发布到 Terraform 的步骤 注册表。为此，您将生成 GPG 签名密钥，设置 GitHub 用于生成提供程序的发布工件的操作，然后添加 GPG 密钥 到地形注册表。将提供程序发布到注册表是永久性的，因此 为了保持注册表整洁，您实际上不会发布HashiCups。 供应商。



警告

请不要将你的HashiCups副本发布到Terraform。 注册表。使用本教程作为参考来发布您自己的自定义地形 供应商。

## 先决条件

要学习本教程，您需要：

- [Go 1.19+](https://golang.org/doc/install) 已安装并配置。
- [Terraform v1.0.3+](https://developer.hashicorp.com/terraform/tutorials/aws-get-started/install-cli) 本地安装。
- 本地安装的 [GNUPG](https://www.gnupg.org/download/) CLI 命令 （）。`gpg`
- [GitHub 帐户](https://github.com/)。

若要将 HashiCups 提供程序发布并发布到 Terraform Registry，必须在您拥有的 GitHub 存储库中公开托管源代码。



注意

将提供程序发布到 Terraform 注册表后，无法取消发布提供程序。因此，请密切关注您使用的 GitHub 存储库和组织。例如，考虑您是要以自己还是您的公司身份发布。

继续上一教程新设置

导航到您的目录。`terraform-provider-hashicups-pf`

您的代码应与示例存储库中的[`文档生成`分支](https://github.com/hashicorp/terraform-provider-hashicups-pf/tree/documentation-generation)匹配。

创建一个空的公共 [GitHub 存储库](https://github.com/new)并将其命名为 。`terraform-provider-hashicups-pf`

在本地目录中，完成以下步骤以将代码推送到新存储库。`terraform-provider-hashicups-pf`

首先，删除当前遥控器。这将取消本地资料库与 的关联，因此您可以添加新的 .`origin``hashicorp/terraform-provider-hashicups-pf``origin`

```shell-session
$ git remote rm origin
```

复制

然后，添加一个指向新创建的 GitHub 仓库的远程仓库，替换为您的 GitHub 组织名称或用户名。`GH_ORG`

```shell-session
$ git remote add origin https://github.com/GH_ORG/terraform-provider-hashicups-pf.git
```

复制

接下来，将现有代码移动到分支。`main`

```shell-session
$ git branch -M main
```

复制

最后，将代码推送到 GitHub 存储库。

```shell-session
$ git push -u origin main
```

复制

## 验证地形注册表清单文件

注册表清单向 Terraform 注册表提供有关提供程序的其他信息。

验证该文件是否存在于存储库的根目录中。`terraform-registry-manifest.json`

请注意，文件的内容指定文件本身的版本以及提供程序使用的 Terraform 协议版本。



terraform-registry-manifest.json

```json
{
  "version": 1,
  "metadata": {
    "protocol_versions": ["6.0"]
  }
}
```

## 验证 GoReleaser 配置

GoReleaser 是一个工具，用于为多个平台构建 Go 项目、创建校验和文件以及签署版本。

验证该文件是否存在于存储库的根目录中。`.goreleaser.yml`

此配置生成并签署必要的发布项目，以将提供程序发布到 Terraform 注册表。GitHub Action 工作流将使用此配置运行 GoReleaser。HashiCorp 维护此 GoReleaser 配置文件，以便与您发布的任何提供程序一起使用。

## 验证 GitHub 操作工作流

验证目录中是否存在该文件`release.yml``.github/workflows/`

每当在主分支上标记提交时，此 GitHub 操作都会发布提供程序的新版本。

## 生成 GPG 签名密钥

您需要一个 GPG 签名密钥才能使用 GoReleaser 对提供程序二进制文件进行签名，并在 Terraform 注册表中验证提供程序。 Terraform Registry 仅支持 RSA 和 DSA 密钥。

生成您的 GPG 密钥对。当系统提示选择哪种键时，请响应 以选择该选项。`1``RSA and RSA`

```shell-session
$ gpg --full-generate-key
gpg (GnuPG) 2.3.6; Copyright (C) 2021 Free Software Foundation, Inc.
This is free software: you are free to change and redistribute it.
There is NO WARRANTY, to the extent permitted by law.

Please select what kind of key you want:
   (1) RSA and RSA
   (2) DSA and Elgamal
   (3) DSA (sign only)
   (4) RSA (sign only)
   (9) ECC (sign and encrypt) *default*
  (10) ECC (sign only)
  (14) Existing key from card
Your selection?
```

复制

提示输入密钥大小时输入。`4096`

```shell-session
RSA keys may be between 1024 and 4096 bits long.
What keysize do you want? (3072) 4096
Requested keysize is 4096 bits
```

Press to accept the default option, indicating that the key does not expire.`Enter`

```shell-session
Please specify how long the key should be valid.
         0 = key does not expire
      <n>  = key expires in n days
      <n>w = key expires in n weeks
      <n>m = key expires in n months
      <n>y = key expires in n years
Key is valid for? (0)
Key does not expire at all
```

Confirm your selection by entering .`y`

```shell-session
Is this correct? (y/N) y
```

Create a user ID at the prompt. Use your own information, not the example information below. Leave the comment blank.

```shell-session
GnuPG needs to construct a user ID to identify your key.

Real name: Terraform Education
Email address: team-terraform-education@hashicorp.com
Comment:
```

When prompted, confirm your by entering . Save your , you will use this later to generate your private and public keys.`USER-ID``O``USER-ID`

```shell-session
You selected this USER-ID:
    "Terraform Education <team-terraform-education@hashicorp.com>"

Change (N)ame, (C)omment, (E)mail or (O)kay/(Q)uit? O
```

Finally, create and confirm your passphrase. This passphrase is used to decrypt your GPG private key, select a strong passphrase and keep it secure.

### Generate GPG public key

Generate your GPG public key. Later, you will add this key to the Terraform Registry. When you publish a new version of your provider to the Terraform Registry, the registry will validate that the release is signed with this keypair and Terraform will verify the provider during .`terraform init`

Replace with the you used when creating your GPG key (Your name and email address).`KEY_ID``USER-ID`

```shell-session
$ gpg --armor --export "KEY_ID"
-----BEGIN PGP PUBLIC KEY BLOCK-----

mQINBGB91soBEACp/u6jJZAKeVahHGtR6jzDFcOvivhUFV2fuwBBW/jxqYrWEeEX
+rny8oChQjCABHG9bUxhSSqPyfCK/kUI3VK8Qrxpby6dQgqOFuF61P1mBI0BppLF
JGydv8J9SIIbYJOyajFzMLrvL+xvKD1AblRFBtQke8ts+gz9B+oW7SmAVMb3gM4n
##...
-----END PGP PUBLIC KEY BLOCK-----
```

Copy

### Generate GPG private key

Generate your GPG private key. GoReleaser will use this to sign the provider releases.

Replace with the you used when creating your GPG key. GPG will prompt you to enter the passphrase you created earlier.`KEY_ID``USER-ID`

```shell-session
$ gpg --armor --export-secret-keys "KEY_ID"
-----BEGIN PGP PRIVATE KEY BLOCK-----

lQdFBGB91soBEACp/u6jJZAKeVahHGtR6jzDFcOvivhUFV2fuwBBW/jxqYrWEeEX
+rny8oChQjCABHG9bUxhSSqPyfCK/kUI3VK8Qrxpby6dQgqOFuF61P1mBI0BppLF
JGydv8J9SIIbYJOyajFzMLrvL+xvKD1AblRFBtQke8ts+gz9B+oW7SmAVMb3gM4n
##...
-----END PGP PRIVATE KEY BLOCK-----
```

Copy



Note

Be sure to save your production GPG keys and passphrases and back them up in a secure location.

## Add GitHub secrets for GitHub Action

The GitHub Action requires your GPG private key and passphrase to generate a release.

In your **forked** GitHub repository, go to **Settings**, then **Secrets**, then **Actions**, and click the **New repository secret** button to add the following repository secrets.

- [`GPG_PRIVATE_KEY`](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-release-publish#gpg_private_key). This is the private GPG key you generated in the [previous step](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-release-publish#generate-gpg-private-key). Include the and lines.`-----BEGIN...``-----END`
- [`密码短语`](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-release-publish#passphrase)。这是您的 GPG 私钥的密码短语。

![Add secrets to your forked GitHub repository for GoReleaser GH Actions](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fterraform%2Fproviders%2Fhashicups-github-secrets.png)

## 创建提供程序版本

每当将新的有效版本标记推送到存储库时，GitHub 操作都会触发并为您的提供程序创建版本。地形提供程序版本必须遵循[语义版本控制](https://semver.org/)标准 （）。`vMAJOR.MINOR.PATCH`

首先，将更改添加到新提交中。

```shell-session
$ git add .
```

复制

然后，提交更改。

```shell-session
$ git commit -m 'Add docs, goreleaser, and GH actions'
```

复制

接下来，创建一个新标签。

```shell-session
$ git tag v0.2.1
```

复制

最后，将标签推送到 GitHub。

```shell-session
$ git push origin v0.2.1
```

复制

### 验证提供程序版本

在**分支存储库**中，转到**操作**。你应该找到 GitHub 您之前创建的操作工作流正在运行。



提示

您可能需要在 GitHub 操作运行之前确认并批准工作流操作。如果需要，请批准工作流操作并手动触发运行。

![View GitHub Action creating release artifacts](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fterraform%2Fproviders%2Fhashicups-github-action.png)

GitHub 操作完成后，您应该会在主存储库页面的右侧找到该版本。

![New release for HashiCups provider](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fterraform%2Fproviders%2Fhashicups-github-release.png)

## Add GPG public key to Terraform Registry

Go to the [Terraform Registry](https://registry.terraform.io/) and sign in with your GitHub account.

Next, go to [**User Settings**, then **Signing Keys**](https://registry.terraform.io/settings/gpg-keys). Select **+ New GPG Key** and add the GPG Public signing key you generated in a [previous step](https://developer.hashicorp.com/terraform/tutorials/providers-plugin-framework/providers-plugin-framework-release-publish#generate-gpg-public-key).

![Add public GPG key to Terraform Registry](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fterraform%2Fproviders%2Fterraform-registry-gpg-key.png)

单击**保存**以添加您的公共签名密钥。

## 将提供程序发布到地形注册表

由于您无法从 Terraform 注册表中取消发布提供程序，因此在本教程中不会实际发布 HashiCups 提供程序。但是，本节将引导您完成实际提供程序应遵循的步骤。可以安全地执行本节中的大多数步骤，但不要单击末尾的**“发布”**按钮。

在 Terraform 注册表中，选择**“发布**”，然后选择顶部导航栏中的**“提供程序**”。

![Open providers page in Terraform Registry](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fterraform%2Fproviders%2Fterraform-registry-provider.png)

选择您的组织，然后选择包含您的 Terraform 提供程序的 GitHub 存储库。

选择您的提供商类别，然后通过选中该框阅读并同意“使用条款”。



警告

不要单击**“发布**”。使用本教程作为发布您自己的自定义 Terraform 提供程序的参考。请不要将您的HashiCups副本发布到Terraform Registry。

![Terraform Registry publish provider confirmation page](https://content.hashicorp.com/api/assets?product=tutorials&version=main&asset=public%2Fimg%2Fterraform%2Fproviders%2Fterraform-registry-publish-provider.png)

## 后续步骤

祝贺！您已经发布了提供程序，并演练了将其添加到 Terraform 注册表的步骤。

在这些教程的过程中，您重新创建了 HashiCups 提供程序，并学习了如何创建数据源、向 HashiCups 客户端验证提供程序、使用 CRUD 功能创建资源以及导入现有资源。此外，您已经将 HashiCups 提供程序发布并发布到 Terraform Registry。

官方、合作伙伴和社区 Terraform 提供商的完整列表可以在 [Terraform 提供商注册表](https://registry.terraform.io/browse/providers)中找到。我们鼓励您找到您感兴趣的提供商并开始贡献！

- 若要快速创建新的 Terraform 提供程序，[Terraform 提供程序基架框架](https://github.com/hashicorp/terraform-provider-scaffolding-framework)是一个可以克隆的模板存储库。
- 若要了解有关发布和发布 Terraform 提供程序的不同方法的详细信息，请参阅[发布提供程序文档页](https://developer.hashicorp.com/terraform/registry/providers/publishing)。
- 要了解有关记录 Terraform 提供程序的详细信息，请参阅[提供程序文档文档页面](https://developer.hashicorp.com/terraform/registry/providers/docs)。
- 了解有关 Terraform 插件的更多信息 框架，参考 [Terraform 插件框架 文档](https://developer.hashicorp.com/terraform/plugin/framework)。
- 向 [Terraform 插件框架 Github 存储库](https://github.com/hashicorp/terraform-plugin-framework)中的开发团队提交任何 Terraform 插件框架错误报告或功能请求。
- 在 [Terraform 插件框架讨论论坛中提交任何 Terraform 插件框架](https://discuss.hashicorp.com/c/terraform-providers/tf-plugin-sdk/43)问题。