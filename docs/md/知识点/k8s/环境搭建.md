## 基础环境
MacBook Pro M1 MacOS 13.3
VMware Fusion 13
CentOS-Stream-9-latest-aarch64-dvd1.iso 最小化安装
## CentOS 配置
### 配置 ssh
#### 开启root用户远程登录
linux系统是默认禁止远程登录root用户
```shell
vi /etc/ssh/sshd_config
```
在文件中找到(可以使用搜索功能： 输入/Permit，找到后再按i进行编辑)
```shell
#PermitRootLogin prohibit-password

# 变更为

PermitRootLogin yes
```
按 esc，输入 :wq 保存，重启 ssh
```shell
service sshd restart
```
#### 导入ssh公钥
然后使用远程工具通过root用户的密码登录CentOS 9
```shell
vim ~/.ssh/authorized_keys
```
将已有的 id_rsa.pub 公钥的内容复制进去，按 esc，输入 :wq 保存，在通过远程工具使用 ssh 登录CentOS 9
### 更换 yum 源
#### 备份源配置
```shell
mv /etc/yum.repos.d/centos.repo /etc/yum.repos.d/centos.repo.backup

mv /etc/yum.repos.d/centos-addons.repo /etc/yum.repos.d/centos-addons.repo.backup
```
#### 重写源配置
将 [清华大学开源软件镜像站-CentOS Stream 软件仓库镜像使用帮助](https://mirrors.tuna.tsinghua.edu.cn/help/centos-stream/) 
```shell
vim /etc/yum.repos.d/centos.repo

vim /etc/yum.repos.d/centos-addons.repo
```
#### 更新缓存
```shell
yum makecache && yum update
```
### 设置静态IP
先查看 CentOS 使用的网卡，然后需要修改的网卡信息
```shell
ip addr

cd /etc/NetworkManager/system-connections/

ls  # 如 ens160.nmconnection

vim ens160.nmconnection
```
配置参考
```shell
[connection]
id=ens160
uuid=e3e7f376-9406-3500-813a-6f9fb790b7fb
type=ethernet
autoconnect-priority=-999
interface-name=ens160
timestamp=1684422360

[ipv4]
address1=192.168.64.135/24,192.168.64.2
dns=114.114.114.114
method=manual
```
重启网卡
```shell
nmcli c reload && nmcli c up ens160 # 网卡名 ens160
```
关闭防火墙
```shell
systemctl stop firewalld

systemctl disable firewalld
```
## 配置 Docker
使用 [清华大学开源软件镜像站-Docker CE 软件仓库镜像使用帮助](https://mirrors.tuna.tsinghua.edu.cn/help/docker-ce/) 脚本安装 Docker
```shell
export DOWNLOAD_URL="https://mirrors.tuna.tsinghua.edu.cn/docker-ce"

# 如您使用 wget
wget -O- https://get.docker.com/ | sudo -E sh
```
启动并加入开机启动
```shell
systemctl start docker

systemctl enable docker
```
配置 Docker 源镜像
```shell
vim /etc/docker/daemon.json

{
  "registry-mirrors": [
  	"http://hub-mirror.c.163.com"
  ],
  "exec-opts": ["native.cgroupdriver=systemd"]
}
```

配置 docker.service，修改 ExecStart ??????  docker 起不来
```shell
ExecStart=/usr/bin/dockerd -H fd:// --containerd=/run/containerd/containerd.sock --exec-opt native.cgroupdriver=systemd
```

重启docker服务使配置生效
```shell
systemctl daemon-reload

systemctl enable docker

systemctl restart docker
```
## 配置 K8s
### k8s-master
#### 前置条件
更改主机名
```shell
hostnamectl set-hostname k8s-master
```
配置节点的域名
```shell
vim /etc/hosts

# 配置样例
192.168.64.135 k8s-master
192.168.64.136 k8s-node1
192.168.64.137 k8s-node2
```
关闭 SeLinux
```shell
setenforce 0

sed -i "s/SELINUX=enforcing/SELINUX=disabled/g" /etc/selinux/config
```
关闭 swap
```shell
swapoff -a

yes | cp /etc/fstab /etc/fstab_bak

cat /etc/fstab_bak |grep -v swap > /etc/fstab
```
#### 安装
备份 kubernetes.repo文件
```shell
cp /etc/yum.repos.d/kubernetes.repo /etc/yum.repos.d/kubernetes.repo.bak
```
修改 kubernetes.repo文件
```shell
[kubernetes]
name=kubernetes
baseurl=https://mirrors.tuna.tsinghua.edu.cn/kubernetes/yum/repos/kubernetes-el7-$basearch
enabled=1



[kubernetes]
name=Kubernetes
baseurl=https://repo.huaweicloud.com/kubernetes/yum/repos/kubernetes-el7-$basearch
enabled=1
gpgcheck=1
repo_gpgcheck=0
gpgkey=https://repo.huaweicloud.com/kubernetes/yum/doc/yum-key.gpg https://repo.huaweicloud.com/kubernetes/yum/doc/rpm-package-key.gpg
```
更新索引文件
```shell
yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

systemctl enable --now kubelet
```
查看安装情况
```shell
rpm -qa | grep kubelet          # kubelet-1.23.1-0.aarch64
rpm -qa | grep kubeadm          # kubeadm-1.23.1-0.aarch64
rpm -qa | grep kubectl          # kubectl-1.23.1-0.aarch64
rpm -qa | grep kubernetes-cni   # kubernetes-cni-0.8.7-0.aarch64
```

安装 bash-completion
[https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-linux/](https://kubernetes.io/zh-cn/docs/tasks/tools/install-kubectl-linux/)
启动 kubectl 自动补全功能
安装 kubectl convert 插件

安装 cri-dockerd

yum install -y kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6 --nogpgcheck

#### 初始化Master节点
将桥接的IPv4流量传递到iptables的链
```shell
echo "1" >/proc/sys/net/bridge/bridge-nf-call-iptables
```
centos7用户还需要设置路由 修改 k8s.conf ????????
```shell
vim /etc/sysctl.d/k8s.conf

net.bridge.bridge-nf-call-ip6tables = 1
net.bridge.bridge-nf-call-iptables = 1
vm.swappiness=0
```
让上述配置命令生效
```
sysctl --system
```

始化主节点
```shell
kubeadm config images pull --image-repository registry.aliyuncs.com/google_containers
```

```shell
kubeadm init --kubernetes-version=1.23.6 \
--apiserver-advertise-address=10.168.99.101 \
--image-repository registry.aliyuncs.com/google_containers \
--service-cidr=10.1.0.0/16 \
--pod-network-cidr=10.244.0.0/16 \
--ignore-preflight-errors=Swap


kubeadm init --kubernetes-version=1.26.1 \
--apiserver-advertise-address=10.168.99.101 \
--image-repository registry.aliyuncs.com/google_containers \
--service-cidr=10.1.0.0/16 \
--pod-network-cidr=10.244.0.0/16 \
--ignore-preflight-errors=Swap


kubeadm init --kubernetes-version=1.24.1 \
--apiserver-advertise-address=10.168.99.101 \
--image-repository registry.aliyuncs.com/google_containers \
--service-cidr=10.1.0.0/16 \
--pod-network-cidr=10.244.0.0/16 \
--ignore-preflight-errors=Swap


kubeadm init --kubernetes-version=1.27.2 \
--apiserver-advertise-address=10.168.99.101 \
--image-repository registry.aliyuncs.com/google_containers \
--service-cidr=10.1.0.0/16 \
--pod-network-cidr=10.244.0.0/16 \
--ignore-preflight-errors=Swap
```




The reset process does not clean CNI configuration. To do so, you must remove /etc/cni/net.d

## 


# 将 SELinux 设置为 permissive 模式（相当于将其禁用）

sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes  --nogpgcheck

sudo systemctl enable --now kubelet

yum install -y kubelet-1.23.6 kubeadm-1.23.6 kubectl-1.23.6 --disableexcludes=kubernetes --nogpgcheck

```bash
sudo setenforce 0
sudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes

sudo systemctl enable --now kubelet
```


```bash
cat <<EOF | sudo tee /etc/modules-load.d/k8s.conf
overlay
br_netfilter
EOF

sudo modprobe overlay
sudo modprobe br_netfilter

# 设置所需的 sysctl 参数，参数在重新启动后保持不变
cat <<EOF | sudo tee /etc/sysctl.d/k8s.conf
net.bridge.bridge-nf-call-iptables  = 1
net.bridge.bridge-nf-call-ip6tables = 1
net.ipv4.ip_forward                 = 1
EOF

# 应用 sysctl 参数而不重新启动
sudo sysctl --system
```
[https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/](https://kubernetes.io/zh-cn/docs/setup/production-environment/container-runtimes/)
